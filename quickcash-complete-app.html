<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickCash - Complete Loan Application</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #6c63ff;
            --secondary: #4a42e8;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #6e8efb, #a777e3); min-height: 100vh; transition: all 0.8s ease; }
        body.dashboard-mode { background: #f5f7fa; }
        
        /* Loading Screen */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        
        /* Auth Container */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .auth-card { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.95); border-radius: 24px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); overflow: hidden; }
        .auth-header { background: linear-gradient(135deg, #4a6cf7, #8a3ffb); color: white; padding: 30px 20px; text-align: center; }
        .auth-logo { font-size: 2rem; font-weight: 700; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .auth-logo i { margin-right: 12px; font-size: 2.2rem; }
        .auth-tabs { display: flex; background: #f8f9fa; }
        .auth-tab { flex: 1; text-align: center; padding: 18px; cursor: pointer; font-weight: 600; color: #6c757d; transition: all 0.3s ease; }
        .auth-tab.active { color: var(--primary); background: white; border-bottom: 3px solid var(--primary); }
        .auth-content { padding: 30px; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; transition: all 0.3s ease; }
        .form-input:focus { border-color: var(--primary); outline: none; }
        .auth-button { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .field-error { color: var(--danger); font-size: 0.85rem; margin-top: 6px; display: none; }
        .message { padding: 14px 16px; border-radius: 10px; margin-bottom: 12px; font-weight: 500; display: none; }
        .message.error { background: #fef2f2; color: #dc2626; }
        .message.success { background: #f0fdf4; color: #16a34a; }
        
        /* Common Header */
        .app-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; text-align: center; position: relative; box-shadow: 0 4px 20px rgba(108, 99, 255, 0.3); }
        .app-logo { font-size: 1.8rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }
        .app-logo i { margin-right: 10px; font-size: 28px; }
        .back-btn, .profile-btn { position: absolute; top: 20px; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; width: 45px; height: 45px; color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .back-btn { left: 20px; }
        .profile-btn { right: 20px; }
        .back-btn:hover, .profile-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        
                 /* Dashboard */
         .dashboard-container { display: none; min-height: 100vh; padding-bottom: 80px; background-color: #f5f7fa; }
         
         /* Welcome Banner */
         .welcome-banner {
             background: linear-gradient(135deg, var(--primary), var(--secondary));
             color: white;
             padding: 20px;
             border-radius: 12px;
             margin: 20px;
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
             text-align: center;
         }
         
         .welcome-banner h1 {
             font-size: 1.5rem;
             font-weight: 600;
             margin-bottom: 5px;
         }
         
         .welcome-banner p {
             font-size: 0.9rem;
             opacity: 0.9;
         }
         
         /* Mobile Features Container */
         .mobile-features-container {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 15px;
             background: #ffffff;
             overflow-x: auto;
             white-space: nowrap;
             -webkit-overflow-scrolling: touch;
             gap: 10px;
         }

         .feature-card {
             display: inline-flex;
             flex-direction: column;
             align-items: center;
             text-align: center;
             background: #f8f9fa;
             border-radius: 10px;
             padding: 15px;
             min-width: 120px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             flex-shrink: 0;
         }

         .feature-icon {
             font-size: 24px;
             color: #007bff;
             margin-bottom: 8px;
         }

         .feature-title {
             font-size: 14px;
             font-weight: 600;
             color: #2d3748;
             margin-bottom: 4px;
             white-space: normal;
         }

         .feature-desc {
             font-size: 12px;
             color: #718096;
             white-space: normal;
         }

         /* Hide scrollbar */
         .mobile-features-container::-webkit-scrollbar {
             display: none;
         }

         /* Amazon note */
         .amazon-note {
             text-align: center;
             padding: 10px;
             font-size: 12px;
             color: #666;
             margin-top: 5px;
         }
         
         /* Loan Banner - Compact Layout */
         .loan-banner {
             background: linear-gradient(135deg, #6a11cb, #2575fc);
             color: white;
             border-radius: 12px;
             padding: 20px;
             margin: 0 20px 20px;
             text-align: center;
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
         }
         
         .loan-title {
             font-size: 1.3rem;
             font-weight: 600;
             margin-bottom: 5px;
         }
         
         .loan-amount {
             font-size: 2rem;
             font-weight: 700;
             margin: 10px 0;
         }
         
         .loan-details {
             display: flex;
             justify-content: space-between;
             margin: 15px 0;
             flex-wrap: wrap;
         }
         
         .loan-detail {
             flex: 1;
             min-width: 30%;
             margin-bottom: 10px;
         }
         
         .detail-value {
             font-weight: 600;
             font-size: 1.1rem;
         }
         
         .detail-label {
             font-size: 0.8rem;
             opacity: 0.9;
         }
         
         .apply-btn {
             background: white;
             color: var(--primary);
             border: none;
             padding: 12px;
             border-radius: 8px;
             font-weight: 600;
             width: 100%;
             margin-top: 10px;
             cursor: pointer;
             transition: all 0.3s;
         }
         
         .apply-btn:hover {
             transform: translateY(-2px);
             box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
         }
         
         /* Quick Actions - 2x2 Grid */
         .quick-actions {
             margin: 20px;
         }
         
         .quick-actions-title {
             font-size: 1.2rem;
             font-weight: 600;
             margin-bottom: 15px;
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
         
         .toggle-btn {
             background: none;
             border: none;
             color: var(--primary);
             font-weight: 500;
             cursor: pointer;
             display: flex;
             align-items: center;
             gap: 5px;
         }
         
         .toggle-btn i {
             transition: transform 0.3s;
         }
         
         .actions-grid {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 15px;
             transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
         }
         
         .actions-grid.collapsed {
             height: 0;
             overflow: hidden;
             opacity: 0;
             transform: translateY(-20px);
         }
         
         .action-btn {
             background: white;
             border-radius: 10px;
             padding: 15px;
             text-align: center;
             box-shadow: 0 3px 10px rgba(0,0,0,0.05);
             display: flex;
             flex-direction: column;
             align-items: center;
             text-decoration: none;
             color: var(--dark);
             transition: all 0.3s;
             cursor: pointer;
         }
         
         .action-btn:hover {
             transform: translateY(-3px);
             box-shadow: 0 5px 15px rgba(0,0,0,0.1);
         }
         
         .action-icon {
             width: 40px;
             height: 40px;
             background: rgba(108, 99, 255, 0.1);
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-bottom: 10px;
             color: var(--primary);
         }
         
         .action-label {
             font-weight: 500;
             font-size: 0.9rem;
         }
         
         /* Animations */
         @keyframes fadeIn {
             from { opacity: 0; transform: translateY(20px); }
             to { opacity: 1; transform: translateY(0); }
         }
         
         @keyframes slideIn {
             from { opacity: 0; transform: translateY(30px); }
             to { opacity: 1; transform: translateY(0); }
         }
         
         .fade-in {
             animation: fadeIn 0.5s ease-out;
         }
         
         .slide-in {
             animation: slideIn 0.6s ease-out;
         }
         
         /* KYC Warning */
         .kyc-warning {
             background: #ff4757;
             color: white;
             padding: 10px;
             border-radius: 8px;
             margin-top: 10px;
             text-align: center;
             font-weight: 500;
             animation: pulse 1.5s infinite;
         }
         
         .kyc-warning i {
             margin-right: 8px;
         }
         
         @keyframes pulse {
             0% { opacity: 1; }
             50% { opacity: 0.7; }
             100% { opacity: 1; }
         }
         
         .apply-btn.locked {
             background: #ccc;
             color: #666;
             cursor: not-allowed;
             opacity: 0.6;
         }
         
         .apply-btn.locked:hover {
             transform: none;
             box-shadow: none;
         }
         
         /* KYC Section Styles */
         .kyc-section { display: none; padding: 20px; padding-bottom: 100px; background-color: #f5f7fa; }
         
         .form-container {
             background-color: white;
             border-radius: 15px;
             padding: 30px;
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
             max-width: 600px;
             margin: 20px auto;
             animation: fadeIn 0.5s ease-out;
         }
         
         .form-title {
             font-size: 1.8rem;
             color: #4a6cf7;
             margin-bottom: 25px;
             text-align: center;
             font-weight: 600;
         }
         
         .error {
             color: #ff4757;
             background-color: rgba(255, 71, 87, 0.1);
             padding: 12px 15px;
             border-radius: 8px;
             margin-bottom: 20px;
             font-size: 0.9rem;
             display: flex;
             align-items: center;
             animation: shake 0.5s;
         }
         
         @keyframes shake {
             0%, 100% { transform: translateX(0); }
             20%, 60% { transform: translateX(-5px); }
             40%, 80% { transform: translateX(5px); }
         }
         
         .error i {
             margin-right: 10px;
         }
         
         .form-group {
             margin-bottom: 20px;
             position: relative;
         }
         
         .form-group label {
             display: block;
             margin-bottom: 8px;
             font-weight: 500;
             color: #555;
         }
         
         .form-control {
             width: 100%;
             padding: 12px 15px;
             border: 1px solid #ddd;
             border-radius: 8px;
             font-size: 1rem;
             transition: all 0.3s;
             background-color: #f9f9f9;
         }
         
         .form-control:focus {
             border-color: #4a6cf7;
             outline: none;
             background-color: white;
             box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
         }
         
         .form-control.error-field {
             border-color: #ff4757;
             animation: shake 0.5s;
         }
         
         .error-message {
             color: #ff4757;
             font-size: 0.8rem;
             margin-top: 5px;
             display: none;
         }
         
         .word-count {
             position: absolute;
             right: 15px;
             bottom: 15px;
             font-size: 0.8rem;
             color: #ff4757;
         }
         
         .word-count.valid {
             color: #28a745;
         }
         
         .next-btn {
             width: 100%;
             padding: 15px;
             background: linear-gradient(135deg, #4a6cf7, #8a3ffb);
             color: white;
             border: none;
             border-radius: 10px;
             font-size: 1.1rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s;
             margin-top: 10px;
             box-shadow: 0 5px 15px rgba(74, 108, 247, 0.3);
         }
         
         .next-btn:hover {
             background: linear-gradient(135deg, #3a5ce4, #7a2ffa);
             transform: translateY(-3px);
             box-shadow: 0 8px 20px rgba(74, 108, 247, 0.4);
         }
         
         .next-btn i {
             margin-left: 8px;
             transition: transform 0.3s;
         }
         
         .next-btn:hover i {
             transform: translateX(5px);
         }
         
         select.form-control {
             appearance: none;
             background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
             background-repeat: no-repeat;
             background-position: right 15px center;
             background-size: 15px;
         }
        
        /* Admin Panel Styles */
        .admin-section { display: none; padding: 20px; padding-bottom: 100px; background-color: #f5f7fa; }
        
        .admin-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .admin-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .admin-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .admin-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .admin-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .users-table, .loans-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .users-table th, .users-table td,
        .loans-table th, .loans-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .users-table th, .loans-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-verified { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-active { background: #d1ecf1; color: #0c5460; }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-view { background: #17a2b8; color: white; }
        
        .btn-small:hover { transform: translateY(-1px); }

        /* Profile Section */
        .profile-section { display: none; padding: 20px; padding-bottom: 100px; background-color: #f5f7fa; }
        .profile-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); text-align: center; color: white; }
        .user-avatar { width: 100px; height: 100px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 700; margin: 0 auto 20px; border: 3px solid rgba(255, 255, 255, 0.3); }
        .user-name { font-size: 26px; font-weight: 700; margin-bottom: 10px; color: white; }
        .user-mobile { font-size: 18px; color: rgba(255, 255, 255, 0.9); margin-bottom: 15px; }
        .user-status { display: inline-block; padding: 10px 20px; background: rgba(255, 255, 255, 0.2); color: white; border-radius: 25px; font-size: 16px; font-weight: 600; text-transform: uppercase; }
        .menu-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .menu-item { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .menu-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        .menu-icon { width: 50px; height: 50px; border-radius: 50%; background: #f8f9ff; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; color: var(--primary); font-size: 20px; }
        .menu-text { font-size: 14px; font-weight: 500; color: #333; }
        .logout-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #ff4757, #ff6b81); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .logout-btn:hover { background: linear-gradient(135deg, #e84118, #ff4757); transform: translateY(-2px); }
        
        /* Repay Section */
        .repay-section { display: none; padding: 20px; padding-bottom: 100px; }
        .repay-container { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .section-title { color: var(--primary); margin-bottom: 20px; text-align: center; font-size: 22px; font-weight: 600; }
        .loan-details { background: #f8f9ff; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e0e5ff; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
        .detail-label { color: #555; font-weight: 500; }
        .detail-value { font-weight: 600; color: #333; }
        .total-row { border-top: 1px solid #e0e5ff; margin-top: 15px; padding-top: 15px; font-size: 16px; font-weight: 700; color: var(--primary); }
        .payment-methods { text-align: center; margin: 25px 0; }
        .qr-container { background: white; border: 2px dashed #e0e5ff; border-radius: 15px; padding: 20px; margin-bottom: 20px; max-width: 280px; margin-left: auto; margin-right: auto; }
        .qr-code { width: 200px; height: 200px; border: 1px solid #eee; border-radius: 10px; }
        .upi-container { margin: 20px 0; }
        .upi-id { font-size: 16px; font-weight: 600; color: #333; padding: 15px; background: #f8f9ff; border-radius: 10px; margin: 15px 0; word-break: break-all; border: 1px solid #e0e5ff; }
        .copy-btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }
        .copy-btn i { margin-right: 8px; }
        .repay-form { margin-top: 25px; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-field { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1); outline: none; }
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--success), #20c997); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3); }
        .payment-guide { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .guide-title { color: var(--primary); margin-bottom: 15px; font-size: 16px; font-weight: 600; }
        .guide-list { padding-left: 20px; }
        .guide-list li { margin-bottom: 8px; font-size: 14px; color: #666; line-height: 1.5; }
        
        /* Loan Status Cards */
        .loan-status-cards { display: grid; gap: 15px; margin-bottom: 30px; }
        .status-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .loan-id { font-size: 14px; color: #666; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-active { background: #e3f2fd; color: #1976d2; }
        .status-pending { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e9; color: #388e3c; }
        .loan-amount { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 10px; }
        .loan-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { color: #666; font-size: 12px; margin-bottom: 2px; }
        .info-value { font-weight: 600; color: #333; }
        
        /* Bottom Navigation */
        .bottom-navigation { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #9ca3af; cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: all 0.3s ease; }
        .nav-item.active { color: var(--primary); background: rgba(108, 99, 255, 0.1); }
        .nav-item:hover { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 4px; }
        .nav-item span { font-size: 0.8rem; font-weight: 500; }
        
        /* Popups */
        .popup-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .popup-overlay.active { opacity: 1; visibility: visible; }
        .popup-content { background: white; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .popup-title { font-size: 20px; font-weight: 600; color: var(--primary); }
        .popup-close { background: none; border: none; font-size: 24px; color: #666; cursor: pointer; }
        .popup-btn { padding: 12px 30px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        /* Notification Toast */
        .notification { position: fixed; top: 20px; right: 20px; padding: 16px 20px; border-radius: 12px; color: white; font-weight: 500; z-index: 10000; transform: translateX(400px); transition: transform 0.4s; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, var(--success), #10b981); }
        .notification.error { background: linear-gradient(135deg, var(--danger), #ef4444); }
        .notification.info { background: linear-gradient(135deg, var(--info), #3b82f6); }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 1000; display: none; animation: fadeInOut 2s ease-in-out; }
        @keyframes fadeInOut { 0% { opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
        
        /* Responsive */
        @media (max-width: 768px) {
            .quick-actions { grid-template-columns: 1fr; }
            .menu-container { grid-template-columns: 1fr; }
            .loan-info { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 10px;">QuickCash</div>
        <div style="font-size: 1rem; opacity: 0.8;">Loading your application...</div>
    </div>

    <!-- Login System -->
    <div class="login-container" id="loginContainer">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-money-bill-wave"></i> Quick Cash
                </div>
                <div>Get instant loans with minimal documentation</div>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>
            
            <div class="auth-content">
                <div id="authMessages"></div>
                
                <form class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Mobile Number</label>
                        <input type="text" id="loginMobile" class="form-input" placeholder="Enter mobile number" maxlength="10" required>
                        <div class="field-error" id="loginMobileError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" required>
                        <div class="field-error" id="loginPasswordError"></div>
                    </div>
                    <button type="submit" class="auth-button">Sign In</button>
                </form>
                
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="registerName" class="form-input" placeholder="Enter full name" required>
                        <div class="field-error" id="registerNameError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Number</label>
                        <input type="text" id="registerMobile" class="form-input" placeholder="Enter mobile number" maxlength="10" required>
                        <div class="field-error" id="registerMobileError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email (Optional)</label>
                        <input type="email" id="registerEmail" class="form-input" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="Create password" required>
                        <div class="field-error" id="registerPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm password" required>
                        <div class="field-error" id="confirmPasswordError"></div>
                    </div>
                    <button type="submit" class="auth-button">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardContainer">
        <div class="app-header">
            <div class="app-logo">
                <i class="fas fa-money-bill-wave"></i> QuickCash
            </div>
            <button class="profile-btn" onclick="showSection('profile')">
                <i class="fas fa-user"></i>
            </button>
        </div>
        
        <!-- Welcome Banner -->
        <div class="welcome-banner slide-in">
            <h1 id="welcomeTitle">Welcome, User!</h1>
            <p>We're here to help you with your financial needs</p>
        </div>
        
        <div class="mobile-features-container">
            <!-- Feature 1 -->
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                <div class="feature-title">Fast Approval</div>
                <div class="feature-desc">Within Minutes</div>
            </div>
            
            <!-- Feature 2 -->
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="feature-title">Instant Loan</div>
                <div class="feature-desc">Direct to Account</div>
            </div>
            
            <!-- Feature 3 -->
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="feature-title">Secure Process</div>
                <div class="feature-desc">256-bit Encryption</div>
            </div>
        </div>

        <div class="amazon-note">
            <i class="fab fa-amazon" style="color: #FF9900;"></i> Trusted by amazon - Safe & Secure - 24/7 support
        </div>
            
        <!-- Default Loan Banner - Compact Layout -->
        <div class="loan-banner slide-in">
            <div class="loan-title">Fast And Secure Loan</div>
            <div class="loan-amount">₹500,000</div>
            <div class="loan-details">
                <div class="loan-detail">
                    <div class="detail-value">3 Years</div>
                    <div class="detail-label">Tenure</div>
                </div>
                <div class="loan-detail">
                    <div class="detail-value">0.05%</div>
                    <div class="detail-label">Interest Rate</div>
                </div>
                <div class="loan-detail">
                    <div class="detail-value">Fast</div>
                    <div class="detail-label">Approval</div>
                </div>
            </div>
                         <button class="apply-btn" id="applyBtn" onclick="checkKYCAndApply()">Apply Now</button>
             <div id="kycWarning" class="kyc-warning" style="display: none;">
                 <i class="fas fa-exclamation-triangle"></i>
                 <span>Verify your account first</span>
             </div>
        </div>
            
        <!-- Quick Actions - 2x2 Grid -->
        <div class="quick-actions">
            <div class="quick-actions-title">
                Quick Actions
                <button class="toggle-btn" id="toggleActions">
                    <span id="toggleText">Hide</span>
                    <i class="fas fa-chevron-up" id="toggleIcon"></i>
                </button>
            </div>
            
            <div class="actions-grid" id="actionsGrid">
                <div class="action-btn" onclick="showSection('profile')">
                    <div class="action-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="action-label">Profile</div>
                </div>
                
                <div class="action-btn" onclick="loadMyLoans()">
                    <div class="action-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="action-label">My Loans</div>
                </div>
                
                <div class="action-btn" onclick="showNotification('History coming soon!', 'info')">
                    <div class="action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="action-label">History</div>
                </div>
                
                <div class="action-btn" onclick="showSection('repay')">
                    <div class="action-icon">
                        <i class="fas fa-rupee-sign"></i>
                    </div>
                    <div class="action-label">Repay</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Section -->
    <div class="admin-section" id="adminSection">
        <div class="app-header">
            <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="app-logo">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </div>
        </div>
        
        <div class="admin-header">
            <h1>QuickCash Admin Dashboard</h1>
            <p>Manage users, loans, and system overview</p>
        </div>
        
        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingKyc">0</div>
                <div class="stat-label">Pending KYC</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalLoans">0</div>
                <div class="stat-label">Total Loans</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingLoans">0</div>
                <div class="stat-label">Pending Loans</div>
            </div>
        </div>
        
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="switchAdminTab('users')">
                <i class="fas fa-users"></i> Users
            </div>
            <div class="admin-tab" onclick="switchAdminTab('loans')">
                <i class="fas fa-money-bill"></i> Loans
            </div>
            <div class="admin-tab" onclick="switchAdminTab('kyc')">
                <i class="fas fa-id-card"></i> KYC Requests
            </div>
        </div>
        
        <div class="admin-content">
            <!-- Users Tab -->
            <div id="usersTab" class="admin-tab-content">
                <h3>All Users</h3>
                <div style="overflow-x: auto;">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Mobile</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>KYC Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px;">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Loans Tab -->
            <div id="loansTab" class="admin-tab-content" style="display: none;">
                <h3>All Loans</h3>
                <div style="overflow-x: auto;">
                    <table class="loans-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Purpose</th>
                                <th>Status</th>
                                <th>Applied Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px;">Loading loans...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- KYC Tab -->
            <div id="kycTab" class="admin-tab-content" style="display: none;">
                <h3>KYC Verification Requests</h3>
                <div style="overflow-x: auto;">
                    <table class="loans-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>PAN</th>
                                <th>Aadhar</th>
                                <th>Income</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="kycTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px;">Loading KYC requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Section -->
    <div class="profile-section" id="profileSection">
        <div class="app-header">
            <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="app-logo">
                <i class="fas fa-money-bill-wave"></i> Quick Cash
            </div>
        </div>
        
        <div class="profile-card">
            <div class="user-avatar" id="userAvatar">U</div>
            <h2 class="user-name" id="userName">User Name</h2>
            <div class="user-mobile" id="userMobile">+91 0000000000</div>
            <div class="user-status" id="userStatus">Account Status</div>
        </div>
        
        <div class="menu-container">
            <div class="menu-item" onclick="showNotification('Settings coming soon!', 'info')">
                <div class="menu-icon"><i class="fas fa-cog"></i></div>
                <div class="menu-text">Settings</div>
            </div>
            <div class="menu-item" onclick="loadMyLoans()">
                <div class="menu-icon"><i class="fas fa-rupee-sign"></i></div>
                <div class="menu-text">My Loans</div>
            </div>
            <div class="menu-item" onclick="showNotification('History coming soon!', 'info')">
                <div class="menu-icon"><i class="fas fa-history"></i></div>
                <div class="menu-text">History</div>
            </div>
            <div class="menu-item" onclick="showContactPopup()">
                <div class="menu-icon"><i class="fas fa-headset"></i></div>
                <div class="menu-text">Contact Us</div>
            </div>
            <div class="menu-item" onclick="showTermsPopup()">
                <div class="menu-icon"><i class="fas fa-file-contract"></i></div>
                <div class="menu-text">Terms</div>
            </div>
            <div class="menu-item" onclick="showPrivacyPopup()">
                <div class="menu-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="menu-text">Privacy</div>
            </div>
            <div class="menu-item" id="adminMenuItem" onclick="showSection('admin')" style="display: none;">
                <div class="menu-icon"><i class="fas fa-cogs"></i></div>
                <div class="menu-text">Admin Panel</div>
            </div>
        </div>
        
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <!-- KYC Verification Section -->
    <div class="kyc-section" id="kycSection" style="display: none;">
        <div class="app-header">
            <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="app-logo">
                <i class="fas fa-money-bill-wave"></i> Quick Cash
            </div>
        </div>
        
        <div class="form-container">
            <h2 class="form-title">Complete Your KYC</h2>
            
            <div id="kycError" class="error" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="kycErrorText"></span>
            </div>
            
            <form id="kycForm">
                <div class="form-group">
                    <label for="kycName">Name (as per PAN)</label>
                    <input type="text" id="kycName" name="name" class="form-control" required>
                    <div class="error-message" id="kycNameError">Please Enter Your Name</div>
                </div>
                
                <div class="form-group">
                    <label for="kycDob">Date of Birth</label>
                    <input type="date" id="kycDob" name="dob" class="form-control" required>
                    <div class="error-message" id="kycDobError">Please Select Your Date Of Birth (as per PAN)</div>
                </div>
                
                <div class="form-group">
                    <label for="kycAadhar">Aadhar Number</label>
                    <input type="text" id="kycAadhar" name="aadhar" class="form-control" required pattern="[0-9]{12}" maxlength="12">
                    <div class="error-message" id="kycAadharError">Please Enter 12 digit Aadhar Number</div>
                </div>
                
                <div class="form-group">
                    <label for="kycPan">PAN Number</label>
                    <input type="text" id="kycPan" name="pan" class="form-control" required pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" maxlength="10" style="text-transform: uppercase;">
                    <div class="error-message" id="kycPanError">Please Enter 10 Digit PAN Number (Format: ABCDE1234F)</div>
                </div>
                
                <div class="form-group">
                    <label for="kycOccupation">Occupation</label>
                    <select id="kycOccupation" name="occupation" class="form-control" required>
                        <option value="">Select Occupation</option>
                        <option value="Salaried">Salaried</option>
                        <option value="Self Employed">Self Employed</option>
                        <option value="Business">Business</option>
                        <option value="Student">Student</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="error-message" id="kycOccupationError">Please Select Your Occupation</div>
                </div>
                
                <div class="form-group">
                    <label for="kycMarital">Marital Status</label>
                    <select id="kycMarital" name="marital" class="form-control" required>
                        <option value="">Select Marital Status</option>
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                        <option value="Divorced">Divorced</option>
                        <option value="Widowed">Widowed</option>
                    </select>
                    <div class="error-message" id="kycMaritalError">Please Select Your Marital Status</div>
                </div>
                
                <div class="form-group">
                    <label for="kycPurpose">Purpose of Loan (min 10 words)</label>
                    <textarea id="kycPurpose" name="purpose" class="form-control" required rows="4"></textarea>
                    <div class="word-count" id="kycWordCount">0/10 words</div>
                    <div class="error-message" id="kycPurposeError">Please Enter At Least 10 Words</div>
                </div>
                
                <div class="form-group">
                    <label for="kycIncome">Monthly Income (₹)</label>
                    <input type="number" id="kycIncome" name="income" class="form-control" min="12000" required>
                    <div class="error-message" id="kycIncomeError">Minimum Required Income ₹12,000</div>
                </div>
                
                <div class="form-group">
                    <label for="kycLoanAmount">Loan Amount Needed (₹)</label>
                    <input type="number" id="kycLoanAmount" name="loan_amount" class="form-control" min="1000" required>
                    <div class="error-message" id="kycLoanAmountError">Please Enter Loan Amount</div>
                </div>
                
                <button type="submit" class="next-btn">Complete Verification <i class="fas fa-check-circle"></i></button>
            </form>
        </div>
    </div>

    <!-- Repay Section -->
    <div class="repay-section" id="repaySection">
        <div class="app-header">
            <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="app-logo">
                <i class="fas fa-money-bill-wave"></i> Quick Cash
            </div>
        </div>
        
        <div class="repay-container">
            <h2 class="section-title">Repay Loan</h2>
            
            <!-- Loan Selection -->
            <div class="form-group">
                <label class="form-label">Select Loan to Repay</label>
                <select id="loanSelect" class="form-input" onchange="loadLoanDetails()">
                    <option value="">Select a loan...</option>
                </select>
            </div>
            
            <!-- Loan Details -->
            <div class="loan-details" id="loanDetailsSection" style="display: none;">
                <div class="detail-row">
                    <span class="detail-label">Loan Amount:</span>
                    <span class="detail-value" id="loanAmount">₹0</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Interest Rate:</span>
                    <span class="detail-value" id="interestRate">0%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Interest Amount:</span>
                    <span class="detail-value" id="interestAmount">₹0</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Due Date:</span>
                    <span class="detail-value" id="dueDate">-</span>
                </div>
                <div class="detail-row total-row">
                    <span class="detail-label">Total Repayment Amount:</span>
                    <span class="detail-value" id="totalAmount">₹0</span>
                </div>
            </div>
            
            <!-- Payment Methods -->
            <div class="payment-methods" id="paymentMethodsSection" style="display: none;">
                <div class="qr-container">
                    <p style="margin-bottom: 15px; font-weight: 600;">Scan QR Code to Pay</p>
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y5ZjlmOSIvPgogIDx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBDb2RlPC90ZXh0Pgo8L3N2Zz4K" alt="UPI QR Code" class="qr-code">
                </div>
                
                <div class="upi-container">
                    <p style="margin-bottom: 10px; font-weight: 600;">Or pay directly to our UPI ID:</p>
                    <div class="upi-id">BHARATPE09908182022@yesbankltd</div>
                    <button class="copy-btn" onclick="copyUpiId()">
                        <i class="fas fa-copy"></i> Copy UPI ID
                    </button>
                </div>
            </div>
            
            <!-- Payment Form -->
            <form class="repay-form" id="repayForm" style="display: none;">
                <div class="input-group">
                    <label class="input-label">Enter UTR/Transaction ID</label>
                    <input type="text" id="utrInput" class="input-field" placeholder="Enter UTR or Transaction ID from your payment" required>
                </div>
                
                <button type="submit" class="submit-btn">Submit Payment Details</button>
            </form>
            
            <!-- Payment Guide -->
            <div class="payment-guide">
                <h3 class="guide-title">Payment Instructions:</h3>
                <ol class="guide-list">
                    <li><strong>Only UPI payments are accepted</strong> (Google Pay, PhonePe, PayTM, BHIM, etc.)</li>
                    <li>Select your loan from the dropdown above</li>
                    <li>Pay the exact total amount shown</li>
                    <li>Use either the QR code or UPI ID to make payment</li>
                    <li>After successful payment, enter the UTR/Transaction ID</li>
                    <li>Your repayment will be verified within 24 hours</li>
                    <li>For any issues, contact our support team</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-navigation">
        <div class="nav-item active" onclick="showSection('dashboard')">
            <i class="fas fa-home"></i><span>Home</span>
        </div>
        <div class="nav-item" onclick="showSection('repay')">
            <i class="fas fa-hand-holding-usd"></i><span>Repay</span>
        </div>
        <div class="nav-item" onclick="showNotification('History coming soon!', 'info')">
            <i class="fas fa-history"></i><span>History</span>
        </div>
        <div class="nav-item" onclick="showSection('profile')">
            <i class="fas fa-user"></i><span>Profile</span>
        </div>
    </div>

    <!-- Popups -->
    <div class="popup-overlay" id="termsPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Terms & Conditions</h3>
                <button class="popup-close" onclick="hidePopup('termsPopup')">&times;</button>
            </div>
            <div>
                <h4>1. Loan Agreement</h4>
                <p>By applying for a loan through Quick Cash, you agree to be bound by these terms.</p>
                <h4>2. Interest Rates</h4>
                <p>Interest rates vary based on loan amount and creditworthiness.</p>
                <h4>3. Repayment</h4>
                <p>You agree to repay the loan amount plus interest by the due date.</p>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="popup-btn" onclick="hidePopup('termsPopup')">Got It</button>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="privacyPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Privacy Policy</h3>
                <button class="popup-close" onclick="hidePopup('privacyPopup')">&times;</button>
            </div>
            <div>
                <h4>1. Information Collection</h4>
                <p>We collect personal information to process your loan application.</p>
                <h4>2. Data Protection</h4>
                <p>We implement security measures to protect your data.</p>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="popup-btn" onclick="hidePopup('privacyPopup')">Got It</button>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="contactPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Contact Us</h3>
                <button class="popup-close" onclick="hidePopup('contactPopup')">&times;</button>
            </div>
            <div>
                <p><strong>Email:</strong> support@quickcash.com</p>
                <p><strong>WhatsApp:</strong> +91 98765 43210</p>
                <p><strong>Telegram:</strong> @quickcashsupport</p>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="popup-btn" onclick="hidePopup('contactPopup')">Got It</button>
            </div>
        </div>
    </div>

    <!-- Loan Application Popup -->
    <div class="popup-overlay" id="loanApplicationPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Apply for Loan</h3>
                <button class="popup-close" onclick="hidePopup('loanApplicationPopup')">&times;</button>
            </div>
            <form id="loanApplicationForm">
                <div class="form-group">
                    <label class="form-label">Loan Amount (₹)</label>
                    <input type="number" id="loanAmountInput" class="form-input" placeholder="Enter amount" min="1000" max="500000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Loan Purpose</label>
                    <select id="loanPurpose" class="form-input" required>
                        <option value="">Select purpose</option>
                        <option value="personal">Personal</option>
                        <option value="business">Business</option>
                        <option value="education">Education</option>
                        <option value="medical">Medical</option>
                        <option value="emergency">Emergency</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Monthly Income (₹)</label>
                    <input type="number" id="monthlyIncome" class="form-input" placeholder="Enter monthly income" required>
                </div>
                <button type="submit" class="popup-btn" style="width: 100%; margin-top: 15px;">Submit Application</button>
            </form>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast">UPI ID copied to clipboard!</div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAL5e-5eQfgf1nI6hWTnhwLFgK0Cp89aa0",
            authDomain: "aviator-pr01.firebaseapp.com",
            databaseURL: "https://aviator-pr01-default-rtdb.firebaseio.com",
            projectId: "aviator-pr01",
            storageBucket: "aviator-pr01.firebasestorage.app",
            messagingSenderId: "290788041297",
            appId: "1:290788041297:web:168f99d1532997fb778e70",
            measurementId: "G-ENCBTT4BL8"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();
        
        // Monitor Realtime Database connection
        rtdb.ref('.info/connected').on('value', function(snapshot) {
            if (snapshot.val() === true) {
                console.log('✅ Connected to Firebase Realtime Database');
            } else {
                console.log('❌ Disconnected from Firebase Realtime Database');
            }
        });
        
        let currentUser = null;
        let userData = null;
        let userLoans = [];
        let selectedLoan = null;
        
        // KYC Form Validation and Submission
        function initializeKYCForm() {
            const kycForm = document.getElementById('kycForm');
            if (!kycForm) return;
            
            // Real-time validation and error messages
            kycForm.addEventListener('input', function(e) {
                const target = e.target;
                
                if (target.id === 'kycPurpose') {
                    updateKYCWordCount();
                }
                
                validateKYCField(target);
            });
            
            // Validate on blur
            kycForm.addEventListener('focusout', function(e) {
                validateKYCField(e.target);
            });
            
            // Form submission
            kycForm.addEventListener('submit', handleKYCSubmission);
        }
        
        // Word count for purpose textarea
        function updateKYCWordCount() {
            const purpose = document.getElementById('kycPurpose');
            const wordCount = document.getElementById('kycWordCount');
            const words = purpose.value.trim() === '' ? 0 : purpose.value.trim().split(/\s+/).length;
            
            wordCount.textContent = `${words}/10 words`;
            
            if (words >= 10) {
                wordCount.classList.add('valid');
                wordCount.classList.remove('error');
            } else {
                wordCount.classList.remove('valid');
                wordCount.classList.add('error');
            }
        }
        
        // Field validation
        function validateKYCField(field) {
            const errorElement = document.getElementById(`${field.id}Error`);
            if (!errorElement) return;
            
            if (field.validity.valid) {
                field.classList.remove('error-field');
                errorElement.style.display = 'none';
            } else {
                field.classList.add('error-field');
                
                if (field.validity.valueMissing) {
                    switch(field.id) {
                        case 'kycName': errorElement.textContent = 'Please Enter Your Name'; break;
                        case 'kycDob': errorElement.textContent = 'Please Select Your Date Of Birth (as per PAN)'; break;
                        case 'kycAadhar': errorElement.textContent = 'Please Enter 12 digit Aadhar Number'; break;
                        case 'kycPan': errorElement.textContent = 'Please Enter 10 Digit PAN Number'; break;
                        case 'kycOccupation': errorElement.textContent = 'Please Select Your Occupation'; break;
                        case 'kycMarital': errorElement.textContent = 'Please Select Your Marital Status'; break;
                        case 'kycPurpose': errorElement.textContent = 'Please Enter At Least 10 Words'; break;
                        case 'kycIncome': errorElement.textContent = 'Please Enter Your Monthly Income'; break;
                        case 'kycLoanAmount': errorElement.textContent = 'Please Enter Loan Amount'; break;
                    }
                } else if (field.validity.patternMismatch) {
                    if (field.id === 'kycPan') {
                        errorElement.textContent = 'Please Match The PAN Format (ABCDE1234F)';
                    } else if (field.id === 'kycAadhar') {
                        errorElement.textContent = 'Please Enter 12 Digit Aadhar Number';
                    }
                } else if (field.validity.rangeUnderflow && field.id === 'kycIncome') {
                    errorElement.textContent = 'Minimum Required Income ₹12,000';
                }
                
                errorElement.style.display = 'block';
            }
        }
        
        // KYC Form submission
        async function handleKYCSubmission(e) {
            e.preventDefault();
            
            const form = e.target;
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                validateKYCField(field);
                if (!field.validity.valid) {
                    isValid = false;
                }
            });
            
            // Special validation for word count
            const purpose = document.getElementById('kycPurpose');
            const words = purpose.value.trim() === '' ? 0 : purpose.value.trim().split(/\s+/).length;
            
            if (words < 10) {
                document.getElementById('kycPurposeError').style.display = 'block';
                purpose.classList.add('error-field');
                isValid = false;
            }
            
            if (!isValid) {
                // Scroll to first error
                const firstError = document.querySelector('.error-field');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            try {
                const kycData = {
                    name: document.getElementById('kycName').value.trim(),
                    dob: document.getElementById('kycDob').value,
                    aadhar: document.getElementById('kycAadhar').value.trim(),
                    pan: document.getElementById('kycPan').value.trim().toUpperCase(),
                    occupation: document.getElementById('kycOccupation').value,
                    marital: document.getElementById('kycMarital').value,
                    purpose: document.getElementById('kycPurpose').value.trim(),
                    income: parseInt(document.getElementById('kycIncome').value),
                    loanAmount: parseInt(document.getElementById('kycLoanAmount').value),
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Update user document with KYC data in Firestore
                await db.collection('loanuser').doc(currentUser.uid).update({
                    kycData: kycData,
                    kycStatus: 'verified',
                    kycVerified: true,
                    kycSubmittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Also update in Realtime Database with enhanced KYC tracking
                await rtdb.ref('loanusers/' + currentUser.uid).update({
                    kycData: kycData,
                    kycStatus: 'verified',
                    kycVerified: true,
                    kycSubmittedAt: firebase.database.ServerValue.TIMESTAMP,
                    profileComplete: 100, // 100% profile completion
                    eligibleForLoan: true,
                    creditScore: 750 // Default credit score after KYC
                });
                
                // Save KYC submission to separate collection for audit trail
                await rtdb.ref('kyc_submissions/' + currentUser.uid).set({
                    ...kycData,
                    userId: currentUser.uid,
                    userName: userData.name,
                    userMobile: userData.mobile,
                    submittedAt: firebase.database.ServerValue.TIMESTAMP,
                    verifiedAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'verified',
                    verifiedBy: 'system' // or admin ID
                });
                
                // Create admin notification for KYC verification
                await rtdb.ref('notifications/admin').push({
                    type: 'kyc_verification_completed',
                    userId: currentUser.uid,
                    userName: userData.name,
                    userMobile: userData.mobile,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false
                });
                
                // Update system statistics
                const kycStatsRef = rtdb.ref('statistics/totalKycVerified');
                await kycStatsRef.transaction((currentCount) => {
                    return (currentCount || 0) + 1;
                });
                
                // Update local userData
                userData.kycData = kycData;
                userData.kycStatus = 'verified';
                userData.kycVerified = true;
                
                showMessage('KYC verification completed successfully!', 'success');
                
                // Update UI
                updateKYCStatus();
                
                // Go back to dashboard
                setTimeout(() => {
                    showSection('dashboard');
                }, 2000);
                
            } catch (error) {
                console.error('KYC submission error:', error);
                showKYCError(error.message || 'Failed to submit KYC. Please try again.');
            }
        }
        
        function showKYCError(message) {
            const errorDiv = document.getElementById('kycError');
            const errorText = document.getElementById('kycErrorText');
            
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
         // Manual Firebase check function
         window.checkFirebaseUsers = async function() {
             try {
                 console.log('🔍 Checking Firebase Realtime Database for users...');
                 
                 // Check loanusers path
                 const usersSnapshot = await rtdb.ref('loanusers').once('value');
                 const users = usersSnapshot.val();
                 
                 if (users) {
                     console.log('✅ Users found in Firebase Realtime Database:');
                     console.log('📊 Total users:', Object.keys(users).length);
                     
                     Object.entries(users).forEach(([uid, userData]) => {
                         console.log(`👤 User ${uid}:`, {
                             name: userData.name,
                             mobile: userData.mobile,
                             email: userData.email,
                             status: userData.status,
                             role: userData.role
                         });
                     });
                 } else {
                     console.log('❌ No users found in Firebase Realtime Database');
                 }
                 
                 // Also check Firestore
                 console.log('🔍 Checking Firestore for users...');
                 const firestoreUsers = await db.collection('loanuser').get();
                 
                 if (!firestoreUsers.empty) {
                     console.log('✅ Users found in Firestore:');
                     console.log('📊 Total users:', firestoreUsers.size);
                     
                     firestoreUsers.forEach(doc => {
                         const data = doc.data();
                         console.log(`👤 User ${doc.id}:`, {
                             name: data.name,
                             mobile: data.mobile,
                             email: data.email,
                             status: data.status,
                             role: data.role
                         });
                     });
                 } else {
                     console.log('❌ No users found in Firestore');
                 }
                 
             } catch (error) {
                 console.error('❌ Error checking Firebase:', error);
             }
         };
         
                  // Admin Panel Functions
         function switchAdminTab(tabName) {
             // Hide all tabs
             document.querySelectorAll('.admin-tab-content').forEach(tab => {
                 tab.style.display = 'none';
             });
             
             // Remove active class from all tabs
             document.querySelectorAll('.admin-tab').forEach(tab => {
                 tab.classList.remove('active');
             });
             
             // Show selected tab
             document.getElementById(tabName + 'Tab').style.display = 'block';
             
             // Add active class to clicked tab
             event.target.classList.add('active');
         }
         
         async function loadAdminData() {
             try {
                 console.log('🔥 Loading admin data...');
                 
                 // Load all users from loanusers
                 const usersSnapshot = await rtdb.ref('loanusers').once('value');
                 const users = usersSnapshot.val();
                 console.log('✅ Users loaded:', users);
                 
                 // Load all loans
                 const loansSnapshot = await rtdb.ref('loans').once('value');
                 const loans = loansSnapshot.val();
                 console.log('✅ Loans loaded:', loans);
                 
                 // Update statistics
                 updateAdminStats(users, loans);
                 
                 // Update tables
                 updateUsersTable(users);
                 updateLoansTable(loans);
                 updateKYCTable(users);
                 
             } catch (error) {
                 console.error('❌ Error loading admin data:', error);
             }
         }
         
         function updateAdminStats(users, loans) {
             const userCount = users ? Object.keys(users).length : 0;
             const pendingKyc = users ? Object.values(users).filter(user => user.kycStatus === 'pending').length : 0;
             const loanCount = loans ? Object.keys(loans).length : 0;
             const pendingLoans = loans ? Object.values(loans).filter(loan => loan.status === 'pending').length : 0;
             
             document.getElementById('totalUsers').textContent = userCount;
             document.getElementById('pendingKyc').textContent = pendingKyc;
             document.getElementById('totalLoans').textContent = loanCount;
             document.getElementById('pendingLoans').textContent = pendingLoans;
         }
         
         function updateUsersTable(users) {
             const tbody = document.getElementById('usersTableBody');
             
             if (!users) {
                 tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No users found</td></tr>';
                 return;
             }
             
             let html = '';
             Object.values(users).forEach(user => {
                 const joinDate = new Date(user.createdAt).toLocaleDateString();
                 const kycStatus = user.kycStatus || 'pending';
                 
                 html += `
                     <tr>
                         <td>${user.name}</td>
                         <td>${user.mobile}</td>
                         <td>${user.email}</td>
                         <td><span class="status-badge status-${user.role === 'admin' ? 'active' : 'verified'}">${user.role.toUpperCase()}</span></td>
                         <td><span class="status-badge status-${kycStatus}">${kycStatus.toUpperCase()}</span></td>
                         <td>${joinDate}</td>
                         <td>
                             <div class="action-buttons">
                                 <button class="btn-small btn-view" onclick="viewUser('${user.uid}')">View</button>
                                 ${user.role !== 'admin' ? `<button class="btn-small btn-approve" onclick="makeAdmin('${user.uid}')">Make Admin</button>` : ''}
                             </div>
                         </td>
                     </tr>
                 `;
             });
             
             tbody.innerHTML = html;
         }
         
         function updateLoansTable(loans) {
             const tbody = document.getElementById('loansTableBody');
             
             if (!loans) {
                 tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No loans found</td></tr>';
                 return;
             }
             
             let html = '';
             Object.values(loans).forEach(loan => {
                 const appliedDate = new Date(loan.appliedAt).toLocaleDateString();
                 
                 html += `
                     <tr>
                         <td>${loan.userName}</td>
                         <td>₹${loan.amount.toLocaleString()}</td>
                         <td>${loan.purpose.substring(0, 30)}...</td>
                         <td><span class="status-badge status-${loan.status}">${loan.status.toUpperCase()}</span></td>
                         <td>${appliedDate}</td>
                         <td>
                             <div class="action-buttons">
                                 <button class="btn-small btn-view" onclick="viewLoan('${loan.id}')">View</button>
                                 ${loan.status === 'pending' ? `
                                     <button class="btn-small btn-approve" onclick="approveLoan('${loan.id}')">Approve</button>
                                     <button class="btn-small btn-reject" onclick="rejectLoan('${loan.id}')">Reject</button>
                                 ` : ''}
                             </div>
                         </td>
                     </tr>
                 `;
             });
             
             tbody.innerHTML = html;
         }
         
         function updateKYCTable(users) {
             const tbody = document.getElementById('kycTableBody');
             
             if (!users) {
                 tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No KYC requests found</td></tr>';
                 return;
             }
             
             const kycUsers = Object.values(users).filter(user => user.kycData);
             
             if (kycUsers.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No KYC requests found</td></tr>';
                 return;
             }
             
             let html = '';
             kycUsers.forEach(user => {
                 const kycData = user.kycData;
                 const submittedDate = new Date(user.kycSubmittedAt).toLocaleDateString();
                 
                 html += `
                     <tr>
                         <td>${user.name}</td>
                         <td>${kycData.pan}</td>
                         <td>${kycData.aadhar}</td>
                         <td>₹${kycData.income.toLocaleString()}</td>
                         <td><span class="status-badge status-${user.kycStatus}">${user.kycStatus.toUpperCase()}</span></td>
                         <td>${submittedDate}</td>
                         <td>
                             <div class="action-buttons">
                                 <button class="btn-small btn-view" onclick="viewKYC('${user.uid}')">View</button>
                                 ${user.kycStatus === 'pending' ? `
                                     <button class="btn-small btn-approve" onclick="approveKYC('${user.uid}')">Approve</button>
                                     <button class="btn-small btn-reject" onclick="rejectKYC('${user.uid}')">Reject</button>
                                 ` : ''}
                             </div>
                         </td>
                     </tr>
                 `;
             });
             
             tbody.innerHTML = html;
         }

         // Initialize App
         document.addEventListener('DOMContentLoaded', function() {
             initializeKYCForm();
             showLoading();
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData().then(() => {
                        loadUserLoans().then(() => {
                            showSection('dashboard');
                            hideLoading();
                        });
                    });
                } else {
                    showSection('login');
                    hideLoading();
                }
            });
            
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('loanApplicationForm').addEventListener('submit', handleLoanApplication);
            document.getElementById('repayForm').addEventListener('submit', handleRepayment);
        }
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1500);
        }
        
        function showSection(sectionName) {
            // Hide all sections
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('kycSection').style.display = 'none';
            document.getElementById('repaySection').style.display = 'none';
            
            // Show requested section
            switch(sectionName) {
                case 'login':
                    document.getElementById('loginContainer').style.display = 'flex';
                    document.body.classList.remove('dashboard-mode');
                    break;
                case 'dashboard':
                    document.getElementById('dashboardContainer').style.display = 'block';
                    document.body.classList.add('dashboard-mode');
                    break;
                case 'admin':
                    document.getElementById('adminSection').style.display = 'block';
                    document.body.classList.add('dashboard-mode');
                    loadAdminData();
                    break;
                case 'kyc':
                    document.getElementById('kycSection').style.display = 'block';
                    document.body.classList.add('dashboard-mode');
                    updateNavigation('dashboard');
                    break;
                case 'profile':
                    document.getElementById('profileSection').style.display = 'block';
                    document.body.classList.add('dashboard-mode');
                    updateNavigation('profile');
                    break;
                case 'repay':
                    document.getElementById('repaySection').style.display = 'block';
                    document.body.classList.add('dashboard-mode');
                    updateNavigation('repay');
                    loadLoansForRepayment();
                    break;
            }
        }
        
        function updateNavigation(activeSection) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            switch(activeSection) {
                case 'dashboard':
                    navItems[0].classList.add('active');
                    break;
                case 'repay':
                    navItems[1].classList.add('active');
                    break;
                case 'profile':
                    navItems[3].classList.add('active');
                    break;
            }
        }
        
        function switchAuthTab(tabName) {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            document.getElementById(tabName + 'Form').classList.add('active');
            
            clearMessages();
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const mobile = document.getElementById('loginMobile').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!validateLoginForm(mobile, password)) return;
            
            try {
                const email = `${mobile}@quickcash.com`;
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const userDoc = await db.collection('loanuser').doc(user.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    showMessage(`Welcome back, ${userData.name}!`, 'success');
                    
                                         await db.collection('loanuser').doc(user.uid).update({
                         lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                         loginCount: firebase.firestore.FieldValue.increment(1)
                     });
                     
                     // Also update in Realtime Database with enhanced tracking
                     try {
                         const userRef = rtdb.ref('loanusers/' + user.uid);
                         await userRef.update({
                             lastLogin: firebase.database.ServerValue.TIMESTAMP,
                             loginCount: firebase.database.ServerValue.increment(1),
                             isOnline: true,
                             lastActivity: firebase.database.ServerValue.TIMESTAMP
                         });
                         
                         // Track login activity in separate collection
                         const loginLogRef = rtdb.ref('user_activity/' + user.uid + '/logins');
                         await loginLogRef.push({
                             timestamp: firebase.database.ServerValue.TIMESTAMP,
                             userAgent: navigator.userAgent,
                             ip: 'client-side' // You can get actual IP from server
                         });
                         
                         // Set user as offline when they disconnect
                         const connectedRef = rtdb.ref('.info/connected');
                         const presenceRef = rtdb.ref('loanusers/' + user.uid + '/isOnline');
                         
                         connectedRef.on('value', (snapshot) => {
                             if (snapshot.val() === true) {
                                 presenceRef.onDisconnect().set(false);
                                 presenceRef.set(true);
                             }
                         });
                         
                         console.log('✅ Login data updated in Realtime Database');
                         console.log('✅ User presence tracking enabled');
                     } catch (rtdbError) {
                         console.error('❌ Error updating login data in Realtime Database:', rtdbError);
                     }
                } else {
                    throw new Error('User data not found');
                }
            } catch (error) {
                console.error('Login error:', error);
                handleAuthError(error);
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const mobile = document.getElementById('registerMobile').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!validateRegisterForm(name, mobile, password, confirmPassword)) return;
            
            try {
                console.log('Starting registration process...');
                
                // Check if mobile already exists
                const existingUser = await db.collection('loanuser').where('mobile', '==', mobile).get();
                if (!existingUser.empty) {
                    throw new Error('Mobile number already registered');
                }
                
                // Create Firebase Auth user
                const authEmail = `${mobile}@quickcash.com`;
                console.log('Creating Firebase Auth user with email:', authEmail);
                const userCredential = await auth.createUserWithEmailAndPassword(authEmail, password);
                const user = userCredential.user;
                console.log('Firebase Auth user created successfully, UID:', user.uid);
                
                await user.updateProfile({ displayName: name });
                
                // Prepare user data for Firestore
                const newUserData = {
                    uid: user.uid,
                    name: name,
                    mobile: mobile,
                    email: email || authEmail,
                    password: password,
                    role: 'user',
                    authEmail: authEmail,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    loginCount: 1,
                    totalLoans: 0,
                    totalBorrowed: 0,
                    activeLoans: 0,
                    creditScore: 750,
                    isVerified: false,
                    isActive: true,
                    status: 'active',
                    profileComplete: true,
                    kycStatus: 'pending',
                    kycVerified: false,
                    kycData: null
                };
                
                // Save to Firestore
                console.log('Saving user data to Firestore...');
                await db.collection('loanuser').doc(user.uid).set(newUserData);
                console.log('✅ User data saved to Firestore successfully');
                
                // Prepare user data for Realtime Database (with current timestamp)
                const currentTime = Date.now();
                const rtdbUserData = {
                    uid: user.uid,
                    name: name,
                    mobile: mobile,
                    email: email || authEmail,
                    password: password,
                    role: 'user', // Explicitly set role as 'user'
                    authEmail: authEmail,
                    createdAt: currentTime,
                    lastLogin: currentTime,
                    loginCount: 1,
                    totalLoans: 0,
                    totalBorrowed: 0,
                    activeLoans: 0,
                    creditScore: 750,
                    isVerified: false,
                    isActive: true,
                    status: 'active',
                    profileComplete: true,
                    kycStatus: 'pending',
                    kycVerified: false,
                    kycData: null,
                    address: '',
                    city: '',
                    state: '',
                    pincode: '',
                    occupation: '',
                    monthlyIncome: 0,
                    bankAccount: '',
                    ifscCode: '',
                    panNumber: '',
                    aadharNumber: ''
                };
                
                // Save to Firebase Realtime Database with enhanced error handling
                console.log('🔥 Attempting to save user data to Realtime Database...');
                console.log('🔥 Database URL:', firebaseConfig.databaseURL);
                console.log('🔥 User UID:', user.uid);
                console.log('🔥 RTDB Path: loanusers/' + user.uid);
                console.log('🔥 RTDB User Data:', rtdbUserData);
                
                try {
                    // Save user data to loanusers database
                    const rtdbRef = rtdb.ref('loanusers/' + user.uid);
                    await rtdbRef.set(rtdbUserData);
                    console.log('✅ User data saved to loanusers database successfully!');
                    
                    // Also save a backup in users_backup for redundancy
                    const backupRef = rtdb.ref('users_backup/' + user.uid);
                    await backupRef.set({
                        ...rtdbUserData,
                        backupCreatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    console.log('✅ User backup data saved successfully!');
                    
                    // Update user statistics
                    const statsRef = rtdb.ref('statistics/totalUsers');
                    await statsRef.transaction((currentCount) => {
                        return (currentCount || 0) + 1;
                    });
                    console.log('✅ User statistics updated!');
                    
                    // Verify data was saved by reading it back
                    console.log('🔍 Verifying data was saved to Firebase...');
                    const verifySnapshot = await rtdbRef.once('value');
                    const savedData = verifySnapshot.val();
                    
                    if (savedData) {
                        console.log('✅ VERIFICATION SUCCESS - Data found in Firebase:');
                        console.log('- Name in Firebase:', savedData.name);
                        console.log('- Mobile in Firebase:', savedData.mobile);
                        console.log('- Email in Firebase:', savedData.email);
                        console.log('- Status in Firebase:', savedData.status);
                        console.log('- Role in Firebase:', savedData.role);
                        console.log('- Created At:', new Date(savedData.createdAt).toLocaleString());
                        
                        // Notify admin of new registration
                        const notificationRef = rtdb.ref('notifications/admin');
                        await notificationRef.push({
                            type: 'new_user_registration',
                            userId: user.uid,
                            userName: rtdbUserData.name,
                            userMobile: rtdbUserData.mobile,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            read: false
                        });
                        console.log('✅ Admin notification sent!');
                        
                    } else {
                        console.error('❌ VERIFICATION FAILED - No data found in Firebase!');
                        throw new Error('Failed to verify user data in Firebase');
                    }
                    
                } catch (rtdbError) {
                    console.error('❌ Firebase Realtime Database Error:', rtdbError);
                    console.error('Error details:', rtdbError.message);
                    
                    // Try to rollback Firestore data if RTDB failed
                    try {
                        await db.collection('loanuser').doc(user.uid).delete();
                        await user.delete(); // Delete the auth user too
                        console.log('⚠️ Rolled back Firestore and Auth due to RTDB failure');
                    } catch (rollbackError) {
                        console.error('❌ Rollback failed:', rollbackError);
                    }
                    
                    throw new Error(`Failed to save user data to database: ${rtdbError.message}`);
                }
                
                // Also verify Firestore data
                const firestoreDoc = await db.collection('loanuser').doc(user.uid).get();
                if (firestoreDoc.exists) {
                    console.log('✅ Firestore data also verified successfully');
                    const fsData = firestoreDoc.data();
                    console.log('- Firestore name:', fsData.name);
                    console.log('- Firestore mobile:', fsData.mobile);
                } else {
                    console.error('❌ Firestore data verification failed');
                }
                
                userData = newUserData;
                
                // Log what was saved for debugging
                console.log('✅ User registration completed!');
                console.log('📊 Saved user data:');
                console.log('- Username:', name);
                console.log('- Phone Number:', mobile);
                console.log('- Email:', email || authEmail);
                console.log('- Account Status:', 'active');
                console.log('- Role:', 'user');
                console.log('- KYC Status:', 'pending');
                
                showMessage(`Welcome ${name}! Registration successful. User data saved to both databases.`, 'success');
                
            } catch (error) {
                console.error('❌ Registration error:', error);
                console.error('Error details:', error.message);
                console.error('Error code:', error.code);
                handleAuthError(error);
            }
        }
        
        async function loadUserData() {
            try {
                if (!currentUser) return;
                
                console.log('📖 Loading user data from both Firestore and Realtime Database...');
                
                // Load from Firestore first
                const userDoc = await db.collection('loanuser').doc(currentUser.uid).get();
                
                // Load from Realtime Database
                const rtdbSnapshot = await rtdb.ref('loanusers/' + currentUser.uid).once('value');
                const rtdbUserData = rtdbSnapshot.val();
                
                if (userDoc.exists && rtdbUserData) {
                    // Merge data from both sources, preferring Realtime Database for real-time fields
                    const firestoreData = userDoc.data();
                    userData = {
                        ...firestoreData,
                        ...rtdbUserData,
                        // Keep Firestore timestamps for certain fields
                        createdAt: firestoreData.createdAt,
                        // Use RTDB for real-time tracking
                        lastLogin: rtdbUserData.lastLogin,
                        loginCount: rtdbUserData.loginCount,
                        isOnline: rtdbUserData.isOnline || false
                    };
                    
                    console.log('✅ User data loaded from both databases');
                    console.log('📊 Merged user data:', {
                        name: userData.name,
                        mobile: userData.mobile,
                        isOnline: userData.isOnline,
                        loginCount: userData.loginCount,
                        lastLogin: userData.lastLogin ? new Date(userData.lastLogin).toLocaleString() : 'Never'
                    });
                    
                    updateUserProfile();
                    
                } else if (userDoc.exists) {
                    // Fallback to Firestore only
                    userData = userDoc.data();
                    console.log('⚠️ Using Firestore data only (RTDB not available)');
                    updateUserProfile();
                    
                } else if (rtdbUserData) {
                    // Fallback to RTDB only
                    userData = rtdbUserData;
                    console.log('⚠️ Using Realtime Database data only (Firestore not available)');
                    updateUserProfile();
                    
                } else {
                    throw new Error('User data not found in any database');
                }
                
                // Set up real-time listeners for user data changes
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('❌ Error loading user data:', error);
                showNotification('Error loading user data', 'error');
            }
        }
        
        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            // Listen for real-time updates to user profile
            const userRef = rtdb.ref('loanusers/' + currentUser.uid);
            userRef.on('value', (snapshot) => {
                const updatedData = snapshot.val();
                if (updatedData && userData) {
                    // Update local userData with real-time changes
                    userData = { ...userData, ...updatedData };
                    updateUserProfile();
                    console.log('🔄 User data updated in real-time');
                }
            });
            
            // Listen for loan updates
            const loansRef = rtdb.ref('loans').orderByChild('userId').equalTo(currentUser.uid);
            loansRef.on('value', (snapshot) => {
                const loans = snapshot.val();
                if (loans) {
                    userLoans = Object.keys(loans).map(key => ({
                        id: key,
                        ...loans[key]
                    }));
                    displayActiveLoans();
                    console.log('🔄 Loans updated in real-time');
                }
            });
            
            console.log('👂 Real-time listeners set up successfully');
        }
        
                 function updateUserProfile() {
             if (!userData) return;
             
             console.log('🔍 User data loaded from Firebase:', userData);
             
             // Update dashboard welcome
             document.getElementById('welcomeTitle').textContent = `Welcome, ${userData.name}!`;
             
             // Update profile section with saved data from registration
             document.getElementById('userAvatar').textContent = userData.name.charAt(0).toUpperCase();
             document.getElementById('userName').textContent = userData.name; // User का नाम जो registration में दिया था
             document.getElementById('userMobile').textContent = `+91 ${userData.mobile}`; // User का phone number
             
             // Show user account status (saved during registration)
             const statusElement = document.getElementById('userStatus');
             const accountStatus = userData.status ? userData.status.toUpperCase() : 'ACTIVE';
             statusElement.textContent = accountStatus; // सिर्फ status show करें
             
             // Color code based on account status
             if (userData.status === 'active') {
                 statusElement.style.background = 'rgba(40, 167, 69, 0.8)'; // Green for active
             } else if (userData.status === 'suspended') {
                 statusElement.style.background = 'rgba(220, 53, 69, 0.8)'; // Red for suspended
             } else {
                 statusElement.style.background = 'rgba(255, 193, 7, 0.8)'; // Yellow for other
             }
             
             // Admin menu visibility based on role (but don't show role in profile)
             const adminMenuItem = document.getElementById('adminMenuItem');
             if (adminMenuItem) {
                 if (userData.role === 'admin') {
                     adminMenuItem.style.display = 'block';
                 } else {
                     adminMenuItem.style.display = 'none';
                 }
             }
             
             // Log what's being displayed
             console.log('📱 Profile displaying:');
             console.log('- Username:', userData.name);
             console.log('- Phone:', userData.mobile);
             console.log('- Account Status:', userData.status);
             
             // Check KYC status and update UI
             updateKYCStatus();
             
             // Initialize toggle functionality
             initializeToggleActions();
         }
         
         function updateKYCStatus() {
             const applyBtn = document.getElementById('applyBtn');
             const kycWarning = document.getElementById('kycWarning');
             
             if (!userData.kycVerified) {
                 // Lock the apply button
                 applyBtn.classList.add('locked');
                 applyBtn.textContent = 'Verify Account First';
                 applyBtn.onclick = function() { showSection('kyc'); };
                 
                 // Show warning
                 kycWarning.style.display = 'block';
             } else {
                 // Enable the apply button
                 applyBtn.classList.remove('locked');
                 applyBtn.textContent = 'Apply Now';
                 applyBtn.onclick = function() { showLoanApplicationForm(); };
                 
                 // Hide warning
                 kycWarning.style.display = 'none';
             }
         }
         
         function checkKYCAndApply() {
             if (!userData.kycVerified) {
                 showSection('kyc');
             } else {
                 showLoanApplicationForm();
             }
         }
         
         function initializeToggleActions() {
             const toggleBtn = document.getElementById('toggleActions');
             const actionsGrid = document.getElementById('actionsGrid');
             const toggleText = document.getElementById('toggleText');
             const toggleIcon = document.getElementById('toggleIcon');
             let isCollapsed = false;
             
             if (toggleBtn) {
                 toggleBtn.addEventListener('click', function() {
                     isCollapsed = !isCollapsed;
                     
                     if (isCollapsed) {
                         actionsGrid.classList.add('collapsed');
                         toggleText.textContent = 'Show';
                         toggleIcon.classList.remove('fa-chevron-up');
                         toggleIcon.classList.add('fa-chevron-down');
                         
                         // Animate items out
                         const items = actionsGrid.querySelectorAll('.action-btn');
                         items.forEach((item, index) => {
                             item.style.animation = `slideOut 0.3s ease-out ${index * 0.1}s forwards`;
                         });
                     } else {
                         actionsGrid.classList.remove('collapsed');
                         toggleText.textContent = 'Hide';
                         toggleIcon.classList.remove('fa-chevron-down');
                         toggleIcon.classList.add('fa-chevron-up');
                         
                         // Animate items in
                         const items = actionsGrid.querySelectorAll('.action-btn');
                         items.forEach((item, index) => {
                             item.style.animation = `slideIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) ${index * 0.1}s forwards`;
                         });
                     }
                 });
             }
             
             // Add animation styles dynamically
             if (!document.getElementById('toggleAnimationStyles')) {
                 const style = document.createElement('style');
                 style.id = 'toggleAnimationStyles';
                 style.textContent = `
                     @keyframes slideOut {
                         to {
                             opacity: 0;
                             transform: translateY(-20px) rotate(10deg);
                         }
                     }
                     
                     @keyframes slideIn {
                         from {
                             opacity: 0;
                             transform: translateY(20px) rotate(-10deg);
                         }
                         to {
                             opacity: 1;
                             transform: translateY(0) rotate(0);
                         }
                     }
                 `;
                 document.head.appendChild(style);
             }
         }
         
         function showStatusCards() {
             // Hide all status cards first
             document.querySelectorAll('.status-card').forEach(card => {
                 card.classList.remove('show');
             });
             
             // Show cards based on user's loans
             if (userLoans.length === 0) {
                 // No loans - could show a welcome message or apply prompt
                 return;
             }
             
             userLoans.forEach(loan => {
                 if (loan.status === 'approved') {
                     document.getElementById('approvedStatus').classList.add('show');
                     document.getElementById('approvedAmount').textContent = `₹${loan.amount.toLocaleString()}`;
                 } else if (loan.status === 'active') {
                     document.getElementById('activeStatus').classList.add('show');
                     document.getElementById('activeAmount').textContent = `₹${loan.amount.toLocaleString()}`;
                 } else if (loan.status === 'pending') {
                     document.getElementById('processingStatus').classList.add('show');
                     document.getElementById('processingAmount').textContent = `₹${loan.amount.toLocaleString()}`;
                 } else if (loan.status === 'rejected') {
                     document.getElementById('rejectedStatus').classList.add('show');
                     document.getElementById('rejectedAmount').textContent = `₹${loan.amount.toLocaleString()}`;
                 }
             });
         }
         
         function viewLoanDetails() {
             showNotification('Loan details feature coming soon!', 'info');
         }
         
         function checkStatus() {
             showNotification('Status check feature coming soon!', 'info');
         }
         
         function reapply() {
             showLoanApplicationForm();
         }
        
        async function loadUserLoans() {
            try {
                if (!currentUser) return;
                
                const loansQuery = await db.collection('loans')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                userLoans = [];
                loansQuery.forEach(doc => {
                    userLoans.push({ id: doc.id, ...doc.data() });
                });
                
                displayActiveLoans();
            } catch (error) {
                console.error('Error loading loans:', error);
                showNotification('Error loading loans', 'error');
            }
        }
        
        function displayActiveLoans() {
            const container = document.getElementById('activeLoansContainer');
            
            if (userLoans.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No active loans found. Apply for your first loan!</p>';
                return;
            }
            
            container.innerHTML = userLoans.map(loan => {
                const statusClass = `status-${loan.status}`;
                const totalAmount = loan.amount + (loan.amount * loan.interestRate / 100);
                
                return `
                    <div class="status-card">
                        <div class="status-header">
                            <span class="loan-id">Loan #${loan.id.substring(0, 8)}</span>
                            <span class="status-badge ${statusClass}">${loan.status}</span>
                        </div>
                        <div class="loan-amount">₹${loan.amount.toLocaleString()}</div>
                        <div class="loan-info">
                            <div class="info-item">
                                <span class="info-label">Interest Rate</span>
                                <span class="info-value">${loan.interestRate}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Total Amount</span>
                                <span class="info-value">₹${totalAmount.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadLoansForRepayment() {
            const loanSelect = document.getElementById('loanSelect');
            loanSelect.innerHTML = '<option value="">Select a loan...</option>';
            
            const activeLoans = userLoans.filter(loan => loan.status === 'active' || loan.status === 'approved');
            
            activeLoans.forEach(loan => {
                const option = document.createElement('option');
                option.value = loan.id;
                option.textContent = `Loan #${loan.id.substring(0, 8)} - ₹${loan.amount.toLocaleString()}`;
                loanSelect.appendChild(option);
            });
        }
        
        function loadLoanDetails() {
            const loanId = document.getElementById('loanSelect').value;
            if (!loanId) {
                document.getElementById('loanDetailsSection').style.display = 'none';
                document.getElementById('paymentMethodsSection').style.display = 'none';
                document.getElementById('repayForm').style.display = 'none';
                return;
            }
            
            selectedLoan = userLoans.find(loan => loan.id === loanId);
            if (!selectedLoan) return;
            
            const interestAmount = selectedLoan.amount * selectedLoan.interestRate / 100;
            const totalAmount = selectedLoan.amount + interestAmount;
            const dueDate = selectedLoan.dueDate ? new Date(selectedLoan.dueDate.seconds * 1000).toLocaleDateString() : 'Not set';
            
            document.getElementById('loanAmount').textContent = `₹${selectedLoan.amount.toLocaleString()}`;
            document.getElementById('interestRate').textContent = `${selectedLoan.interestRate}%`;
            document.getElementById('interestAmount').textContent = `₹${interestAmount.toLocaleString()}`;
            document.getElementById('totalAmount').textContent = `₹${totalAmount.toLocaleString()}`;
            document.getElementById('dueDate').textContent = dueDate;
            
            document.getElementById('loanDetailsSection').style.display = 'block';
            document.getElementById('paymentMethodsSection').style.display = 'block';
            document.getElementById('repayForm').style.display = 'block';
        }
        
        async function handleLoanApplication(e) {
            e.preventDefault();
            
            const amount = parseInt(document.getElementById('loanAmountInput').value);
            const purpose = document.getElementById('loanPurpose').value;
            const monthlyIncome = parseInt(document.getElementById('monthlyIncome').value);
            
            if (!amount || !purpose || !monthlyIncome) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            
            try {
                const loanData = {
                    userId: currentUser.uid,
                    userName: userData.name,
                    userMobile: userData.mobile,
                    amount: amount,
                    purpose: purpose,
                    monthlyIncome: monthlyIncome,
                    interestRate: 12,
                    tenure: 12,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Save to Firestore
                const loanDocRef = await db.collection('loans').add(loanData);
                const loanId = loanDocRef.id;
                
                // Also save to Firebase Realtime Database for real-time updates
                const rtdbLoanData = {
                    ...loanData,
                    id: loanId,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                await rtdb.ref('loans/' + loanId).set(rtdbLoanData);
                console.log('✅ Loan application saved to Realtime Database');
                
                // Update user loan statistics in both databases
                await db.collection('loanuser').doc(currentUser.uid).update({
                    totalLoans: firebase.firestore.FieldValue.increment(1),
                    totalBorrowed: firebase.firestore.FieldValue.increment(amount)
                });
                
                await rtdb.ref('loanusers/' + currentUser.uid).update({
                    totalLoans: firebase.database.ServerValue.increment(1),
                    totalBorrowed: firebase.database.ServerValue.increment(amount),
                    activeLoans: firebase.database.ServerValue.increment(1),
                    lastLoanApplication: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Create notification for admin
                await rtdb.ref('notifications/admin').push({
                    type: 'new_loan_application',
                    userId: currentUser.uid,
                    userName: userData.name,
                    userMobile: userData.mobile,
                    loanId: loanId,
                    amount: amount,
                    purpose: purpose,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false
                });
                
                hidePopup('loanApplicationPopup');
                showNotification('Loan application submitted successfully!', 'success');
                
                // Reload loans
                await loadUserLoans();
                
            } catch (error) {
                console.error('Error applying for loan:', error);
                showNotification('Error submitting loan application', 'error');
            }
        }
        
        async function handleRepayment(e) {
            e.preventDefault();
            
            const utr = document.getElementById('utrInput').value.trim();
            if (!utr || !selectedLoan) {
                showNotification('Please enter UTR and select a loan', 'error');
                return;
            }
            
            try {
                const repaymentData = {
                    loanId: selectedLoan.id,
                    userId: currentUser.uid,
                    userName: userData.name,
                    userMobile: userData.mobile,
                    utr: utr,
                    amount: selectedLoan.amount + (selectedLoan.amount * selectedLoan.interestRate / 100),
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('repayments').add(repaymentData);
                
                // Update loan status to 'repayment_pending'
                await db.collection('loans').doc(selectedLoan.id).update({
                    status: 'repayment_pending',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Payment details submitted successfully! We will verify within 24 hours.', 'success');
                
                // Reset form
                document.getElementById('repayForm').reset();
                document.getElementById('loanSelect').value = '';
                loadLoanDetails();
                
                // Reload loans
                await loadUserLoans();
                
            } catch (error) {
                console.error('Error submitting repayment:', error);
                showNotification('Error submitting payment details', 'error');
            }
        }
        
        function showLoanApplicationForm() {
            document.getElementById('loanApplicationPopup').classList.add('active');
        }
        
        function copyUpiId() {
            const upiId = 'BHARATPE09908182022@yesbankltd';
            navigator.clipboard.writeText(upiId).then(() => {
                const toast = document.getElementById('toast');
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy UPI ID: ', err);
                showNotification('Failed to copy UPI ID', 'error');
            });
        }
        
        function loadMyLoans() {
            if (userLoans.length === 0) {
                showNotification('No loans found', 'info');
                return;
            }
            
            let loansInfo = `You have ${userLoans.length} loan(s):\n\n`;
            userLoans.forEach((loan, index) => {
                loansInfo += `${index + 1}. ₹${loan.amount.toLocaleString()} - ${loan.status}\n`;
            });
            
            alert(loansInfo);
        }
        
        // Validation Functions
        function validateLoginForm(mobile, password) {
            let isValid = true;
            clearFieldErrors();
            
            if (!mobile || !isValidMobile(mobile)) {
                showFieldError('loginMobileError', 'Please enter a valid 10-digit mobile number');
                isValid = false;
            }
            
            if (!password || password.length < 6) {
                showFieldError('loginPasswordError', 'Password must be at least 6 characters');
                isValid = false;
            }
            
            return isValid;
        }
        
        function validateRegisterForm(name, mobile, password, confirmPassword) {
            let isValid = true;
            clearFieldErrors();
            
            if (!name || name.length < 2) {
                showFieldError('registerNameError', 'Name must be at least 2 characters');
                isValid = false;
            }
            
            if (!mobile || !isValidMobile(mobile)) {
                showFieldError('registerMobileError', 'Please enter a valid 10-digit mobile number');
                isValid = false;
            }
            
            if (!password || password.length < 6) {
                showFieldError('registerPasswordError', 'Password must be at least 6 characters');
                isValid = false;
            }
            
            if (password !== confirmPassword) {
                showFieldError('confirmPasswordError', 'Passwords do not match');
                isValid = false;
            }
            
            return isValid;
        }
        
        function isValidMobile(mobile) {
            return /^[6-9]\d{9}$/.test(mobile);
        }
        
        function showFieldError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function clearFieldErrors() {
            document.querySelectorAll('.field-error').forEach(error => {
                error.style.display = 'none';
            });
        }
        
        function showMessage(message, type) {
            const messagesContainer = document.getElementById('authMessages');
            messagesContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
            messagesContainer.querySelector('.message').style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => clearMessages(), 3000);
            }
        }
        
        function clearMessages() {
            document.getElementById('authMessages').innerHTML = '';
        }
        
        function showNotification(message, type = 'info') {
            document.querySelectorAll('.notification').forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, 4000);
        }
        
        function handleAuthError(error) {
            let message = 'An error occurred. Please try again.';
            
            switch (error.code) {
                case 'auth/user-not-found':
                    message = 'No account found with this mobile number.';
                    break;
                case 'auth/wrong-password':
                    message = 'Incorrect password. Please try again.';
                    break;
                case 'auth/email-already-in-use':
                    message = 'Mobile number already registered. Please login instead.';
                    break;
                default:
                    if (error.message.includes('Mobile number already registered')) {
                        message = 'Mobile number already registered. Please login instead.';
                    }
            }
            
            showMessage(message, 'error');
        }
        
        // Popup Functions
        function showTermsPopup() {
            document.getElementById('termsPopup').classList.add('active');
        }
        
        function showPrivacyPopup() {
            document.getElementById('privacyPopup').classList.add('active');
        }
        
        function showContactPopup() {
            document.getElementById('contactPopup').classList.add('active');
        }
        
        function hidePopup(popupId) {
            document.getElementById(popupId).classList.remove('active');
        }
        
        // Close popup when clicking outside
        document.querySelectorAll('.popup-overlay').forEach(popup => {
            popup.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
        
        async function logout() {
            try {
                // Update user status to offline before logout
                if (currentUser) {
                    await rtdb.ref('loanusers/' + currentUser.uid).update({
                        isOnline: false,
                        lastActivity: firebase.database.ServerValue.TIMESTAMP
                    });
                    console.log('User status updated to offline');
                }
                
                await auth.signOut();
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                showNotification('Error logging out', 'error');
            }
        }
        
        // Utility Functions for Firebase Realtime Database Monitoring
        window.firebaseUtils = {
            // Check database connection status
            checkConnection: () => {
                rtdb.ref('.info/connected').once('value', (snapshot) => {
                    const connected = snapshot.val();
                    console.log(`🔗 Firebase Realtime Database Connection: ${connected ? '✅ Connected' : '❌ Disconnected'}`);
                    return connected;
                });
            },
            
            // Get all users from RTDB
            getAllUsers: async () => {
                try {
                    const snapshot = await rtdb.ref('loanusers').once('value');
                    const users = snapshot.val();
                    console.log('👥 All Users in Firebase Realtime Database:');
                    console.table(users);
                    return users;
                } catch (error) {
                    console.error('❌ Error fetching users:', error);
                }
            },
            
            // Get user statistics
            getStatistics: async () => {
                try {
                    const snapshot = await rtdb.ref('statistics').once('value');
                    const stats = snapshot.val();
                    console.log('📊 Database Statistics:');
                    console.table(stats);
                    return stats;
                } catch (error) {
                    console.error('❌ Error fetching statistics:', error);
                }
            },
            
            // Monitor real-time data changes
            monitorChanges: () => {
                console.log('👂 Starting real-time monitoring...');
                
                // Monitor user registrations
                rtdb.ref('loanusers').on('child_added', (snapshot) => {
                    const userData = snapshot.val();
                    console.log('🆕 New User Registered:', userData.name, userData.mobile);
                });
                
                // Monitor loan applications
                rtdb.ref('loans').on('child_added', (snapshot) => {
                    const loanData = snapshot.val();
                    console.log('💰 New Loan Application:', loanData.userName, `₹${loanData.amount}`);
                });
                
                // Monitor admin notifications
                rtdb.ref('notifications/admin').on('child_added', (snapshot) => {
                    const notification = snapshot.val();
                    console.log('🔔 New Admin Notification:', notification.type);
                });
            },
            
            // Stop monitoring
            stopMonitoring: () => {
                rtdb.ref('loanusers').off();
                rtdb.ref('loans').off();
                rtdb.ref('notifications/admin').off();
                console.log('🛑 Monitoring stopped');
            }
        };
        
        // Developer helper: Log Firebase RTDB structure on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('🔍 QuickCash Firebase Realtime Database Integration');
                console.log('📂 Database Structure:');
                console.log('├── loanusers/          (User profiles & data)');
                console.log('├── users_backup/       (Backup user data)');
                console.log('├── loans/              (Loan applications)');
                console.log('├── kyc_submissions/    (KYC verification data)');
                console.log('├── notifications/      (System notifications)');
                console.log('├── user_activity/      (Login & activity logs)');
                console.log('└── statistics/         (System statistics)');
                console.log('');
                console.log('💡 Use window.firebaseUtils to monitor database:');
                console.log('   • firebaseUtils.checkConnection()');
                console.log('   • firebaseUtils.getAllUsers()');
                console.log('   • firebaseUtils.getStatistics()');
                console.log('   • firebaseUtils.monitorChanges()');
                console.log('');
                console.log('🎯 All user account creation now saves to Firebase Realtime Database!');
            }, 2000);
        });
    </script>
</body>
</html>