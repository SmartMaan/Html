<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mines - Complete Casino Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0F1419;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, #1A1F2A 0%, #151A24 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #2A3441;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #00E701;
        }

        .balance-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance {
            background: rgba(0, 231, 1, 0.1);
            border: 1px solid #00E701;
            border-radius: 6px;
            padding: 8px 12px;
            color: #00E701;
            font-weight: 600;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #00E701;
            color: #000;
        }

        .btn-primary:hover {
            background: #00CC01;
        }

        .btn-secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #3A4553;
        }

        .btn-secondary:hover {
            border-color: #00E701;
            color: #00E701;
        }

        /* Main Container */
        .container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        /* Game Area */
        .game-area {
            flex: 1;
            background: #1A1F2A;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2A3441;
        }

        .game-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #fff;
        }

        .game-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #00E701;
        }

        .stat-label {
            font-size: 12px;
            color: #8B949E;
            margin-top: 4px;
        }

        /* Mines Grid */
        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            max-width: 350px;
            margin: 0 auto 20px;
            padding: 20px;
            background: #151A24;
            border-radius: 8px;
            border: 1px solid #2A3441;
        }

        .mine-cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2A3441 0%, #232932 100%);
            border: 2px solid #3A4553;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.15s ease;
            position: relative;
            user-select: none;
        }

        .mine-cell:hover:not(.revealed):not(.disabled) {
            border-color: #00E701;
            background: linear-gradient(135deg, #3A4553 0%, #2A3441 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 231, 1, 0.3);
        }

        .mine-cell.revealed {
            cursor: default;
            transform: none;
        }

        .mine-cell.gem {
            background: linear-gradient(135deg, #00E701 0%, #00CC01 100%);
            border-color: #00E701;
            color: #000;
            animation: gemFound 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 231, 1, 0.5);
        }

        .mine-cell.mine {
            background: linear-gradient(135deg, #FF4444 0%, #CC0000 100%);
            border-color: #FF4444;
            color: #fff;
            animation: mineHit 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
        }

        .mine-cell.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes gemFound {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        @keyframes mineHit {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.15) rotate(-5deg); }
            75% { transform: scale(1.15) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Control Panel */
        .control-panel {
            width: 280px;
            background: #1A1F2A;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2A3441;
            height: fit-content;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
            display: block;
        }

        .input-group {
            position: relative;
        }

        .input-field {
            width: 100%;
            background: #0F1419;
            border: 1px solid #3A4553;
            border-radius: 4px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #00E701;
            box-shadow: 0 0 0 2px rgba(0, 231, 1, 0.2);
        }

        .input-field::placeholder {
            color: #8B949E;
        }

        /* Mines Count Selector */
        .mines-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 8px;
        }

        .mine-option {
            background: #0F1419;
            border: 1px solid #3A4553;
            border-radius: 4px;
            padding: 8px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }

        .mine-option:hover {
            border-color: #00E701;
            background: rgba(0, 231, 1, 0.1);
        }

        .mine-option.selected {
            background: #00E701;
            border-color: #00E701;
            color: #000;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-large {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 6px;
            text-transform: uppercase;
            transition: all 0.2s ease;
        }

        .btn-start {
            background: #00E701;
            color: #000;
            border: none;
        }

        .btn-start:hover {
            background: #00CC01;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 231, 1, 0.4);
        }

        .btn-start:disabled {
            background: #3A4553;
            color: #8B949E;
            cursor: not-allowed;
        }

        .btn-cashout {
            background: #FF6B00;
            color: #fff;
            border: none;
        }

        .btn-cashout:hover {
            background: #E55A00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.4);
        }

        .btn-reset {
            background: transparent;
            color: #fff;
            border: 1px solid #3A4553;
        }

        .btn-reset:hover {
            border-color: #00E701;
            color: #00E701;
            background: rgba(0, 231, 1, 0.1);
        }

        /* Current Win Display */
        .current-win {
            background: rgba(0, 231, 1, 0.1);
            border: 1px solid #00E701;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .win-label {
            font-size: 12px;
            color: #8B949E;
            margin-bottom: 4px;
        }

        .win-amount {
            font-size: 20px;
            font-weight: 700;
            color: #00E701;
        }

        .win-multiplier {
            font-size: 14px;
            color: #00E701;
            margin-top: 4px;
        }

        /* Game History */
        .game-history {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #2A3441;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            font-size: 12px;
            color: #8B949E;
        }

        .history-result {
            font-size: 14px;
            font-weight: 600;
        }

        .history-result.win {
            color: #00E701;
        }

        .history-result.loss {
            color: #FF4444;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1A1F2A;
            border-radius: 8px;
            border: 1px solid #2A3441;
            padding: 30px;
            min-width: 350px;
            max-width: 90vw;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #8B949E;
            font-size: 20px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 6px;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #00E701;
            color: #000;
        }

        .notification.error {
            background: #FF4444;
            color: #fff;
        }

        .notification.info {
            background: #0EA5E9;
            color: #fff;
        }

        /* Auto Play Controls */
        .auto-controls {
            border-top: 1px solid #2A3441;
            padding-top: 15px;
            margin-top: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .checkbox {
            width: 16px;
            height: 16px;
            border: 1px solid #3A4553;
            border-radius: 2px;
            background: #0F1419;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox.checked {
            background: #00E701;
            border-color: #00E701;
        }

        .checkbox.checked::after {
            content: 'âœ“';
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }

        .checkbox-label {
            font-size: 14px;
            color: #fff;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }

            .control-panel {
                width: 100%;
                order: -1;
            }

            .mines-grid {
                max-width: 280px;
            }

            .game-stats {
                justify-content: center;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .balance-section {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Game Status */
        .game-status {
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .status-playing {
            color: #00E701;
        }

        .status-ended {
            color: #FF4444;
        }

        .status-won {
            color: #00E701;
        }

        /* Provably Fair */
        .provably-fair {
            font-size: 12px;
            color: #8B949E;
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .provably-fair:hover {
            color: #00E701;
        }

        /* Additional Animations */
        .mine-cell {
            position: relative;
            overflow: hidden;
        }

        .mine-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .mine-cell:hover::before {
            left: 100%;
        }

        /* Pulse effect for potential win */
        .current-win.pulse {
            animation: winPulse 1s ease-in-out infinite;
        }

        @keyframes winPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <div class="logo-text">ðŸ’£ MINES GAME</div>
        </div>
        <div class="balance-section">
            <div class="balance">
                Balance: $<span id="userBalance">1000.00</span>
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-secondary" onclick="showModal('loginModal')">Login</button>
                <button class="btn btn-primary" onclick="showModal('registerModal')">Sign Up</button>
            </div>
            <div class="auth-buttons" id="userSection" style="display: none;">
                <span id="userEmail" style="margin-right: 10px;"></span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Game Area -->
        <div class="game-area">
            <div class="game-title">Mines</div>
            
            <div class="game-stats">
                <div class="stat-item">
                    <div class="stat-value" id="currentMultiplier">1.00x</div>
                    <div class="stat-label">Multiplier</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="gemsFound">0</div>
                    <div class="stat-label">Gems Found</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="minesCount">3</div>
                    <div class="stat-label">Total Mines</div>
                </div>
            </div>

            <div class="current-win" id="currentWinDisplay">
                <div class="win-label">Potential Win</div>
                <div class="win-amount">$<span id="potentialWin">0.00</span></div>
                <div class="win-multiplier" id="multiplierText">Click "BET" to start</div>
            </div>

            <div class="mines-grid" id="minesGrid">
                <!-- Grid cells will be generated by JavaScript -->
            </div>

            <div class="game-status" id="gameStatus">
                Ready to play! Set your bet and start the game.
            </div>

            <div class="provably-fair" onclick="showProvablyFair()">
                ðŸ”’ Provably Fair - Click to verify
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-section">
                <label class="control-label">Bet Amount ($)</label>
                <div class="input-group">
                    <input type="number" id="betAmount" class="input-field" value="1.00" min="0.10" max="1000" step="0.10" placeholder="Enter bet amount">
                </div>
            </div>

            <div class="control-section">
                <label class="control-label">Number of Mines</label>
                <div class="mines-selector">
                    <div class="mine-option" data-mines="1">1</div>
                    <div class="mine-option selected" data-mines="3">3</div>
                    <div class="mine-option" data-mines="5">5</div>
                    <div class="mine-option" data-mines="10">10</div>
                    <div class="mine-option" data-mines="15">15</div>
                    <div class="mine-option" data-mines="20">20</div>
                    <div class="mine-option" data-mines="24">24</div>
                </div>
            </div>

            <div class="control-section">
                <div class="action-buttons">
                    <button class="btn btn-large btn-start" id="startBtn" onclick="startGame()">
                        ðŸŽ® BET
                    </button>
                    <button class="btn btn-large btn-cashout" id="cashoutBtn" onclick="cashOut()" style="display: none;">
                        ðŸ’° CASH OUT
                    </button>
                    <button class="btn btn-large btn-reset" onclick="resetGame()">
                        ðŸ”„ CLEAR
                    </button>
                </div>
            </div>

            <div class="auto-controls">
                <div class="checkbox-group">
                    <div class="checkbox" id="autoModeCheck" onclick="toggleAutoMode()"></div>
                    <label class="checkbox-label" onclick="toggleAutoMode()">Auto Play Mode</label>
                </div>
                <div id="autoControls" style="display: none;">
                    <div class="control-section">
                        <label class="control-label">Number of Games</label>
                        <input type="number" id="autoGames" class="input-field" value="10" min="1" max="100">
                    </div>
                </div>
            </div>

            <div class="control-section">
                <label class="control-label">Game History</label>
                <div class="game-history" id="gameHistory">
                    <div style="text-align: center; color: #8B949E; padding: 20px;">
                        No games played yet
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            <div class="modal-header">
                <div class="modal-title">Login to Your Account</div>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="loginEmail" class="input-field" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="input-field" required placeholder="Enter your password">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-large btn-start">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('registerModal')">&times;</button>
            <div class="modal-header">
                <div class="modal-title">Create New Account</div>
            </div>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="registerEmail" class="input-field" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="registerPassword" class="input-field" required placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="input-field" required placeholder="Confirm your password">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-large btn-start">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration - Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "your-messaging-sender-id",
            appId: "your-app-id-here"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            var auth = firebase.auth();
            var db = firebase.firestore();
        } catch (error) {
            console.log("Firebase not configured. Using local mode.");
        }

        // Game state
        let gameState = {
            isPlaying: false,
            minePositions: [],
            revealedCells: [],
            gemsFound: 0,
            minesCount: 3,
            betAmount: 1.00,
            currentMultiplier: 1.00,
            gameId: null,
            autoMode: false,
            autoGamesRemaining: 0
        };

        let userBalance = 1000.00;
        let currentUser = null;

        // Enhanced multiplier calculation for realistic casino feel
        const calculateMultiplier = (minesCount, gemsFound) => {
            const totalCells = 25;
            const safeCells = totalCells - minesCount;
            
            if (gemsFound === 0) return 1.00;
            
            let multiplier = 1;
            for (let i = 0; i < gemsFound; i++) {
                const remaining = safeCells - i;
                const totalRemaining = totalCells - i;
                multiplier *= totalRemaining / remaining;
            }
            
            // Apply house edge (3%) for realistic casino experience
            multiplier *= 0.97;
            
            return Math.max(1.00, multiplier);
        };

        // Initialize the game grid with enhanced visuals
        function initializeGrid() {
            const grid = document.getElementById('minesGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'mine-cell';
                cell.dataset.index = i;
                cell.onclick = () => revealCell(i);
                
                // Add subtle index for development (remove in production)
                if (window.location.hostname === 'localhost') {
                    cell.style.fontSize = '10px';
                    cell.style.color = '#333';
                    cell.textContent = i;
                }
                
                grid.appendChild(cell);
            }
        }

        // Generate cryptographically secure random mine positions
        function generateMines(count) {
            const positions = [];
            const crypto = window.crypto || window.msCrypto;
            
            while (positions.length < count) {
                const array = new Uint32Array(1);
                crypto.getRandomValues(array);
                const pos = array[0] % 25;
                
                if (!positions.includes(pos)) {
                    positions.push(pos);
                }
            }
            return positions;
        }

        // Start a new game with enhanced validation
        function startGame() {
            const betInput = document.getElementById('betAmount');
            const betAmount = parseFloat(betInput.value);
            
            // Enhanced validation
            if (betAmount > userBalance) {
                showNotification('Insufficient balance! Please add funds.', 'error');
                return;
            }

            if (betAmount < 0.10) {
                showNotification('Minimum bet is $0.10', 'error');
                return;
            }

            if (betAmount > 1000) {
                showNotification('Maximum bet is $1000', 'error');
                return;
            }

            // Deduct bet from balance
            userBalance -= betAmount;
            updateBalance();

            // Initialize game with enhanced state
            gameState = {
                isPlaying: true,
                minePositions: generateMines(gameState.minesCount),
                revealedCells: [],
                gemsFound: 0,
                betAmount: betAmount,
                currentMultiplier: 1.00,
                gameId: Date.now().toString() + Math.random().toString(36),
                autoMode: gameState.autoMode,
                autoGamesRemaining: gameState.autoGamesRemaining,
                startTime: new Date()
            };

            // Update UI with enhanced feedback
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('cashoutBtn').style.display = 'block';
            document.getElementById('gameStatus').textContent = 'Pick a tile to start revealing...';
            document.getElementById('gameStatus').className = 'game-status status-playing';
            document.getElementById('currentWinDisplay').classList.add('pulse');
            
            updateStats();
            enableGrid();
            saveGameToFirebase();
            
            showNotification('Game started! Good luck finding the gems!', 'info');
        }

        // Reveal a cell with enhanced animations
        function revealCell(index) {
            if (!gameState.isPlaying || gameState.revealedCells.includes(index)) {
                return;
            }

            const cell = document.querySelector(`[data-index="${index}"]`);
            gameState.revealedCells.push(index);

            // Add revealing animation
            cell.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                if (gameState.minePositions.includes(index)) {
                    // Hit a mine - enhanced explosion effect
                    cell.classList.add('revealed', 'mine');
                    cell.innerHTML = 'ðŸ’¥';
                    cell.style.transform = 'scale(1.1)';
                    
                    // Shake effect for dramatic impact
                    document.body.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        document.body.style.animation = '';
                        cell.innerHTML = 'ðŸ’£';
                    }, 500);
                    
                    endGame(false);
                } else {
                    // Found a gem - enhanced celebration
                    cell.classList.add('revealed', 'gem');
                    cell.innerHTML = 'ðŸ’Ž';
                    cell.style.transform = 'scale(1)';
                    gameState.gemsFound++;
                    gameState.currentMultiplier = calculateMultiplier(gameState.minesCount, gameState.gemsFound);
                    updateStats();
                    
                    // Celebration effect for gem
                    createSparkles(cell);
                    
                    // Check if won all possible gems
                    if (gameState.gemsFound === 25 - gameState.minesCount) {
                        setTimeout(() => endGame(true), 500);
                    }
                }
            }, 100);
        }

        // Create sparkle effect for gems
        function createSparkles(element) {
            for (let i = 0; i < 5; i++) {
                const sparkle = document.createElement('div');
                sparkle.innerHTML = 'âœ¨';
                sparkle.style.position = 'absolute';
                sparkle.style.pointerEvents = 'none';
                sparkle.style.fontSize = '12px';
                sparkle.style.animation = `sparkle 1s ease-out forwards`;
                sparkle.style.left = Math.random() * 20 - 10 + 'px';
                sparkle.style.top = Math.random() * 20 - 10 + 'px';
                
                element.appendChild(sparkle);
                
                setTimeout(() => {
                    if (sparkle.parentNode) {
                        sparkle.parentNode.removeChild(sparkle);
                    }
                }, 1000);
            }
        }

        // Enhanced cash out with confirmation
        function cashOut() {
            if (!gameState.isPlaying || gameState.gemsFound === 0) {
                showNotification('No winnings to cash out!', 'error');
                return;
            }
            
            const winnings = gameState.betAmount * gameState.currentMultiplier;
            userBalance += winnings;
            updateBalance();
            
            endGame(true, true);
            showNotification(`Successfully cashed out $${winnings.toFixed(2)}! ðŸŽ‰`, 'success');
            
            // Add celebration effect
            document.getElementById('currentWinDisplay').style.animation = 'winPulse 0.5s ease 3';
        }

        // Enhanced game ending with statistics
        function endGame(won, cashedOut = false) {
            gameState.isPlaying = false;
            gameState.endTime = new Date();
            gameState.gameDuration = gameState.endTime - gameState.startTime;
            
            // Remove pulse effect
            document.getElementById('currentWinDisplay').classList.remove('pulse');
            
            // Reveal all mines with staggered animation
            gameState.minePositions.forEach((pos, index) => {
                setTimeout(() => {
                    const cell = document.querySelector(`[data-index="${pos}"]`);
                    if (!cell.classList.contains('revealed')) {
                        cell.classList.add('revealed', 'mine');
                        cell.innerHTML = 'ðŸ’£';
                    }
                }, index * 100);
            });

            // Calculate final result with detailed stats
            let result = 'loss';
            let winnings = 0;
            
            if (won) {
                winnings = gameState.betAmount * gameState.currentMultiplier;
                if (!cashedOut) {
                    userBalance += winnings;
                    updateBalance();
                }
                result = 'win';
                
                const statusText = cashedOut ? 'Cashed out successfully!' : 'Perfect game! All gems found!';
                document.getElementById('gameStatus').textContent = statusText;
                document.getElementById('gameStatus').className = 'game-status status-won';
                
                if (!cashedOut) {
                    showNotification(`ðŸŽ‰ Amazing! You won $${winnings.toFixed(2)}!`, 'success');
                }
            } else {
                document.getElementById('gameStatus').textContent = 'Game over - Mine exploded!';
                document.getElementById('gameStatus').className = 'game-status status-ended';
                showNotification('ðŸ’¥ Boom! Better luck next time!', 'error');
            }

            // Update UI
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('cashoutBtn').style.display = 'none';
            disableGrid();

            // Save comprehensive game data
            saveGameResult(result, winnings);
            addToHistory(result, winnings);

            // Handle auto mode with countdown
            if (gameState.autoMode && gameState.autoGamesRemaining > 1) {
                gameState.autoGamesRemaining--;
                showNotification(`Auto mode: ${gameState.autoGamesRemaining} games remaining`, 'info');
                
                setTimeout(() => {
                    resetGame();
                    setTimeout(startGame, 1000);
                }, 2000);
            }
        }

        // Enhanced game reset with smooth transitions
        function resetGame() {
            gameState.isPlaying = false;
            gameState.revealedCells = [];
            gameState.gemsFound = 0;
            gameState.currentMultiplier = 1.00;
            
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('cashoutBtn').style.display = 'none';
            document.getElementById('gameStatus').textContent = 'Ready to play! Set your bet and start the game.';
            document.getElementById('gameStatus').className = 'game-status';
            document.getElementById('currentWinDisplay').classList.remove('pulse');
            
            initializeGrid();
            updateStats();
        }

        // Enhanced mine count selection with visual feedback
        function selectMinesCount(count) {
            if (gameState.isPlaying) {
                showNotification('Cannot change mines during active game!', 'error');
                return;
            }
            
            gameState.minesCount = count;
            
            document.querySelectorAll('.mine-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-mines="${count}"]`).classList.add('selected');
            
            updateStats();
            
            // Show difficulty indicator
            let difficulty = 'Easy';
            if (count >= 10) difficulty = 'Hard';
            else if (count >= 5) difficulty = 'Medium';
            
            showNotification(`Difficulty set to ${difficulty} (${count} mines)`, 'info');
        }

        // Enhanced grid control with visual feedback
        function enableGrid() {
            document.querySelectorAll('.mine-cell').forEach(cell => {
                cell.classList.remove('disabled');
                cell.style.cursor = 'pointer';
            });
        }

        function disableGrid() {
            document.querySelectorAll('.mine-cell').forEach(cell => {
                cell.classList.add('disabled');
                cell.style.cursor = 'not-allowed';
            });
        }

        // Enhanced statistics display with real-time updates
        function updateStats() {
            document.getElementById('currentMultiplier').textContent = gameState.currentMultiplier.toFixed(2) + 'x';
            document.getElementById('gemsFound').textContent = gameState.gemsFound;
            document.getElementById('minesCount').textContent = gameState.minesCount;
            
            const potentialWin = gameState.betAmount * gameState.currentMultiplier;
            document.getElementById('potentialWin').textContent = potentialWin.toFixed(2);
            
            if (gameState.isPlaying && gameState.gemsFound > 0) {
                document.getElementById('multiplierText').textContent = `${gameState.gemsFound} gems found - Keep going!`;
            } else if (gameState.isPlaying) {
                document.getElementById('multiplierText').textContent = 'Click tiles to reveal gems';
            } else {
                document.getElementById('multiplierText').textContent = 'Click "BET" to start';
            }
        }

        // Enhanced balance display with formatting
        function updateBalance() {
            const balanceElement = document.getElementById('userBalance');
            const newBalance = userBalance.toFixed(2);
            
            balanceElement.textContent = newBalance;
            
            // Add flash effect for balance changes
            balanceElement.style.animation = 'flash 0.5s ease';
            setTimeout(() => {
                balanceElement.style.animation = '';
            }, 500);
        }

        // Enhanced auto mode with progress tracking
        function toggleAutoMode() {
            const checkbox = document.getElementById('autoModeCheck');
            const controls = document.getElementById('autoControls');
            
            gameState.autoMode = !gameState.autoMode;
            
            if (gameState.autoMode) {
                checkbox.classList.add('checked');
                controls.style.display = 'block';
                gameState.autoGamesRemaining = parseInt(document.getElementById('autoGames').value);
                showNotification(`Auto mode enabled: ${gameState.autoGamesRemaining} games`, 'info');
            } else {
                checkbox.classList.remove('checked');
                controls.style.display = 'none';
                gameState.autoGamesRemaining = 0;
                showNotification('Auto mode disabled', 'info');
            }
        }

        // Firebase Authentication with enhanced error handling
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (typeof auth === 'undefined') {
                showNotification('Login simulated (Firebase not configured)', 'info');
                currentUser = { email: email, uid: 'demo-user' };
                updateAuthUI();
                closeModal('loginModal');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    loadUserData();
                    closeModal('loginModal');
                    showNotification('Welcome back! Login successful!', 'success');
                })
                .catch((error) => {
                    showNotification('Login failed: ' + error.message, 'error');
                });
        }

        function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters!', 'error');
                return;
            }
            
            if (typeof auth === 'undefined') {
                showNotification('Registration simulated (Firebase not configured)', 'info');
                currentUser = { email: email, uid: 'demo-user' };
                updateAuthUI();
                closeModal('registerModal');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    if (typeof db !== 'undefined') {
                        db.collection('users').doc(currentUser.uid).set({
                            email: email,
                            balance: 1000,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            gamesPlayed: 0,
                            totalWinnings: 0
                        });
                    }
                    
                    loadUserData();
                    closeModal('registerModal');
                    showNotification('Account created successfully! Welcome!', 'success');
                })
                .catch((error) => {
                    showNotification('Registration failed: ' + error.message, 'error');
                });
        }

        function logout() {
            if (typeof auth !== 'undefined') {
                auth.signOut().then(() => {
                    currentUser = null;
                    userBalance = 1000;
                    updateBalance();
                    updateAuthUI();
                    resetGame();
                    showNotification('Logged out successfully!', 'info');
                });
            } else {
                currentUser = null;
                userBalance = 1000;
                updateBalance();
                updateAuthUI();
                resetGame();
                showNotification('Logged out successfully!', 'info');
            }
        }

        // Enhanced user data management
        function loadUserData() {
            if (!currentUser || typeof db === 'undefined') {
                updateAuthUI();
                return;
            }
            
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userBalance = userData.balance || 1000;
                        updateBalance();
                    }
                    updateAuthUI();
                    loadGameHistory();
                })
                .catch((error) => {
                    console.error('Error loading user data:', error);
                    updateAuthUI();
                });
        }

        // Enhanced authentication UI
        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('authButtons').style.display = 'none';
                document.getElementById('userSection').style.display = 'flex';
                document.getElementById('userEmail').textContent = currentUser.email;
            } else {
                document.getElementById('authButtons').style.display = 'flex';
                document.getElementById('userSection').style.display = 'none';
            }
        }

        // Enhanced Firebase integration
        function saveGameToFirebase() {
            if (!currentUser || typeof db === 'undefined') return;
            
            db.collection('games').doc(gameState.gameId).set({
                userId: currentUser.uid,
                betAmount: gameState.betAmount,
                minesCount: gameState.minesCount,
                minePositions: gameState.minePositions,
                startTime: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'active',
                gameVersion: '2.0'
            }).catch((error) => {
                console.error('Error saving game:', error);
            });
        }

        function saveGameResult(result, winnings) {
            if (!currentUser || !gameState.gameId || typeof db === 'undefined') return;
            
            const gameData = {
                result: result,
                winnings: winnings,
                gemsFound: gameState.gemsFound,
                finalMultiplier: gameState.currentMultiplier,
                endTime: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'completed',
                gameDuration: gameState.gameDuration || 0
            };
            
            db.collection('games').doc(gameState.gameId).update(gameData);
            
            db.collection('users').doc(currentUser.uid).update({
                balance: userBalance,
                gamesPlayed: firebase.firestore.FieldValue.increment(1),
                totalWinnings: firebase.firestore.FieldValue.increment(winnings)
            }).catch((error) => {
                console.error('Error updating user stats:', error);
            });
        }

        // Enhanced game history
        function loadGameHistory() {
            if (!currentUser || typeof db === 'undefined') return;
            
            db.collection('games')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'completed')
                .orderBy('endTime', 'desc')
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    const historyContainer = document.getElementById('gameHistory');
                    historyContainer.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        historyContainer.innerHTML = '<div style="text-align: center; color: #8B949E; padding: 20px;">No games played yet</div>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const game = doc.data();
                        addHistoryItem(game.result, game.winnings, game.betAmount, game.endTime);
                    });
                })
                .catch((error) => {
                    console.error('Error loading game history:', error);
                });
        }

        function addToHistory(result, winnings) {
            addHistoryItem(result, winnings, gameState.betAmount, new Date());
        }

        function addHistoryItem(result, winnings, betAmount, timestamp) {
            const historyContainer = document.getElementById('gameHistory');
            
            // Remove "no games" message if present
            if (historyContainer.innerHTML.includes('No games played yet')) {
                historyContainer.innerHTML = '';
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const resultText = result === 'win' ? `+$${winnings.toFixed(2)}` : `-$${betAmount.toFixed(2)}`;
            const time = timestamp instanceof Date ? 
                timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) :
                new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            historyItem.innerHTML = `
                <span class="history-time">${time}</span>
                <span class="history-result ${result}">${resultText}</span>
            `;
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            
            // Keep only last 10 items
            while (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // Enhanced modal system
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Enhanced provably fair display
        function showProvablyFair() {
            const gameHash = gameState.gameId ? btoa(gameState.gameId).substring(0, 16) : 'No active game';
            showNotification(`Game Hash: ${gameHash} - Results are cryptographically verifiable`, 'info');
        }

        // Enhanced notification system with queue
        let notificationQueue = [];
        let isShowingNotification = false;

        function showNotification(message, type) {
            notificationQueue.push({ message, type });
            if (!isShowingNotification) {
                processNotificationQueue();
            }
        }

        function processNotificationQueue() {
            if (notificationQueue.length === 0) {
                isShowingNotification = false;
                return;
            }

            isShowingNotification = true;
            const { message, type } = notificationQueue.shift();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                    processNotificationQueue();
                }, 300);
            }, 3000);
        }

        // Enhanced event listeners with better UX
        document.querySelectorAll('.mine-option').forEach(option => {
            option.onclick = () => selectMinesCount(parseInt(option.dataset.mines));
        });

        // Enhanced modal handling
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && !gameState.isPlaying) {
                event.preventDefault();
                startGame();
            } else if (event.code === 'Escape') {
                // Close any open modals
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                document.body.style.overflow = 'auto';
            } else if (event.code === 'KeyC' && gameState.isPlaying && gameState.gemsFound > 0) {
                cashOut();
            }
        });

        // Firebase auth state observer with enhanced handling
        if (typeof auth !== 'undefined') {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData();
                } else {
                    currentUser = null;
                    updateAuthUI();
                }
            });
        }

        // Enhanced initialization with loading state
        window.onload = function() {
            showNotification('ðŸŽ® Mines Game Loaded! Ready to play!', 'success');
            initializeGrid();
            updateStats();
            updateBalance();
            selectMinesCount(3);
            
            // Add some extra CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
                
                @keyframes sparkle {
                    0% { opacity: 1; transform: scale(1) translateY(0); }
                    100% { opacity: 0; transform: scale(0.5) translateY(-20px); }
                }
                
                @keyframes flash {
                    0%, 100% { background-color: transparent; }
                    50% { background-color: rgba(0, 231, 1, 0.2); }
                }
            `;
            document.head.appendChild(style);
        };

        // Enhanced error handling
        window.addEventListener('error', function(event) {
            console.error('Game error:', event.error);
            showNotification('An error occurred. Please refresh the page.', 'error');
        });

        // Enhanced performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    if (perfData && perfData.loadEventEnd > 2000) {
                        console.log('Slow loading detected:', perfData.loadEventEnd + 'ms');
                    }
                }, 0);
            });
        }
    </script>
</body>
</html>